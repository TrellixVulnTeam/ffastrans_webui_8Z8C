<html>
<head>
<link rel="stylesheet" href="/alternate-server/css/override.css"/>

<script src="/socket.io/socket.io.js"></script>
<script src="../dependencies/dhtmlx/dhtmlx.js"></script> 
<link rel="stylesheet" href="../dependencies/dhtmlx/dhtmlx.css" type="text/css"> 


<!-- <script src="../dependencies/dhtmlx/vault/vault.js"></script> -->
<!-- <link rel="stylesheet" href="../dependencies/dhtmlx/vault/vault.css" type="text/css"> -->
<script src="../dependencies/jquery/jquery.js"></script>
<link rel="icon" href="favicon.ico?v=1.1">
<link rel="stylesheet" href="../dependencies/fontawesome/css/all.css" />


<!-- <link href="../dependencies/fancytree/modules/jquery.resizableColumns.css" rel="stylesheet"> -->
<!-- <script src="../dependencies/fancytree/modules/jquery.resizableColumns.js"></script> -->

<script src="../dependencies/fancytree/modules/colResizable-1.6.min.js"></script>

<link href="../dependencies/fancytree/skin-custom-1/ui.fancytree.css" rel="stylesheet">

<script src="../dependencies/fancytree/modules/jquery.fancytree.ui-deps.js"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.js" type="text/javascript"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.dnd.js" type="text/javascript"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.filter.js" type="text/javascript"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.edit.js" type="text/javascript"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.gridnav.js" type="text/javascript"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.table.js" type="text/javascript"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.multi.js"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.persist.js"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.fixed.js"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.contextmenu.js"></script>


 
<!-- jquery-contextmenu (https://github.com/swisnl/jQuery-contextMenu) -->
<link rel="stylesheet"
      href="../dependencies/fancytree/modules/jQuery-contextMenue/jquery.contextMenu.min.css" />
<script src="../dependencies/fancytree/modules/jQuery-contextMenue/jquery.contextMenu.min.js">
</script>

<script src="common/buildWorkflowTree.js"></script> <!-- function parseWorkflows -->

<style>
    /* it's important to set width/height to 100% for full-screen init */
    html, body {
        /* width: 100%; */
        height: 100%;
        margin: 0px;
        overflow: hidden;
        color: #333;
        font: 12px Tahoma;
        line-height: 18px;
        
    }

    .fas {
        opacity: 0.9;                /* Opacity (Transparency) */
        color: rgba(0, 0, 0, 0.9);   /* RGBA Color (Alternative Transparency) */
        
    }

    button {
        cursor: pointer;
        font-size: 12px;
    }

    .progressbar {
        border-radius: 5px;
        height: 15px;
        background-color: #4CAF50;
        margin: 0;
        padding: 0;
        text-align: center;
        vertical-align: middle;
        white-space: nowrap;
    }


    /*layout headers (big blue lines)*/
    .dhxlayout_base_material div.dhx_cell_layout div.dhx_cell_hdr {
        height: 25px;
        line-height: 23px;
        font-size: 12px;
    }

        /*collapse icon in layout header*/
        .dhxlayout_base_material div.dhx_cell_layout div.dhx_cell_hdr div.dhxlayout_arrow.dhxlayout_arrow_ha {
            background-position: -32px -5px;
            z-index: 1;
            margin-top: -3;
        }
    /*collapse icon in layout header*/
    div.dhx_cell_layout div.dhx_cell_hdr div.dhxlayout_arrow.dhxlayout_arrow_vb {
        margin-top: -8px;
        z-index: 1;
    }

    /*fancytree line break*/
    table.fancytree-ext-table tbody tr td {
        /*white-space: nowrap;*/
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
    }

    /* tree column resize issues*/
    table {
        border: 1px;
        table-layout: fixed;
        width: 100%;
        outline: none;
    }
    /* tree column resize issues*/
    th,
    td {
        border: 1px;
        overflow: hidden;
        font-weight: unset;
        
    }
    th{
        border-right: 1px solid grey;
    }
    /* text in tree title column */
    span.fancytree-title {
        padding: 0 0 0;
    }
    /*three dots on text overflow*/
    .celltext {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        user-select: text;
        margin-left: 6px;
		margin-right: 6px;
    }
	.celltext_rtl {
		direction:rtl;
		text-align:left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        user-select: text;
        margin-left: 6px;
		margin-right: 6px;
    }

    .celltext_clicked {
        text-overflow: clip;
        white-space: normal;
        word-break: break-all;
        user-select: text;
    }
   
    /*context menu stuff*/
    td:hover {
        opacity:0.5;
    }
    .context-menu-active {
        opacity:0.5;
    }
</style>


<style id="row_status_colors" type="text/css" id="customstyle">


</style>


<script>
    /* init SOCKET.IO */
    var socket = io();

    /* GLOBALS */
    var mainLayout, runningJobGrid, finishedJobGrid, m_serverconfig, m_userpermissions, m_lastsortelementid, m_lastsortdir;
    var m_rowColorError = "#f28d80"
    var m_rowColorCancelled = "#ffcc80"
	var m_max_history_gridrows = 1000;
    var m_query = {}; //url parameters
    /*load config from server*/
    function loadserverconfig() {
        
        $.ajax({
            url: ("/getuserpermissions" + "?" + Math.random()),
            type: "GET",
            success: function(response) {

                m_userpermissions = JSON.parse(response);
                //load serverconfig and initialize page
                $.ajax({
                    url: ("/getserverconfig" + "?" + Math.random()),
                    type: "GET",
                    success: function(response) {
                        m_serverconfig = JSON.parse(response);
                        init();
                    },
                    error: function(xhr, status) {
                        dhtmlx.message("Fatal error, could not load serverconfig. ");
                        document.body.innerHTML = "Fatal error, could not load serverconfig. " + xhr.responseText;
                    }
                });
            },
            error: function(xhr, status) {
                dhtmlx.message("Fatal error, could not load serverconfig. ");
                document.body.innerHTML = "Fatal error, could not load serverconfig. " + xhr.responseText;
            }

        });

    }

    /*get active jobs immediately - should cause server to push jobs to us via socket.io*/
    function forcejobloading() {

        $.ajax({
            url: ("/getactivejobsajax_treegrid"),
            type: "GET",
            success: function(response) {},
            error: function(xhr, status) {}
        });
    }
    
    
    function toggleJobControl(id,selected_is_on){
        //enable/disable menu buttons
        var tree = $(id).fancytree('getTree');
        var all_selected_nodes = tree.getSelectedNodes();
        var element_names = [];
        if (id.match("active")){
            element_names = ["a_details","a_abort","a_pause","a_resume"];
        }
        if (id.match("history")){
            element_names = ["b_details","b_resubmit","b_delsel"];
        }
        element_names.forEach(function(name){
            document.getElementsByName(name)[0].disabled = (all_selected_nodes == 0);
            if (all_selected_nodes != 0){
                var icon = document.getElementsByName(name)[0].getElementsByTagName("i")[0];
                icon.classList.remove("disabled")
            }else{
                var icon = document.getElementsByName(name)[0].getElementsByTagName("i")[0];
                icon.classList.add("disabled")
            }
        })
        
        
    }
    
    /* render menu buttons based on userpermissions*/
    function addMenuButtons(){
        
        //menu buttons html
        //do not forget to add the button name to togglejobcontrol if you add more btns 
        var a_details = '<button class="btn jobviewer_menu" name="a_details" disabled="true" onclick="click_a_header(this.name)"><i style = "margin-right:3px" class= "fas fa-info-circle fa-sm disabled" ></i>Job Details</button> ';
        var a_abort =   '<button class="btn jobviewer_menu" name="a_abort" disabled="true"  onclick="click_a_header(this.name)"><i style = "margin-right:3px;" class= "fas fa-stop fa-sm disabled" ></i>Abort</button> ';
        var a_pause =   '<button class="btn jobviewer_menu" name="a_pause" disabled="true"  onclick="click_a_header(this.name)"><i style = "margin-right:3px" class= "fas fa-pause fa-sm disabled" ></i>Pause</button> ';
        var a_resume =  '<button class="btn jobviewer_menu" name="a_resume" disabled="true"  onclick="click_a_header(this.name)"><i style = "margin-right:3px" class= "fas fa-play fa-sm disabled" ></i>Resume</button>   ';
        var a_opts =    '<button class="btn jobviewer_menu" name="b_opts" onclick="click_b_header(this.name)" style="float: right;margin-top:4px"><i style = "margin-right:3px;" class= "fas fa-cog fa-sm" ></i>Options</button> ';
        
        var arr_all_in_a = [a_details,a_abort,a_pause,a_resume,a_opts];
        
        var b_details =     '<button class="btn jobviewer_menu" name="b_details" disabled="true"  onclick="click_b_header(this.name)"><i style = "margin-right:3px" class= "fas fa-info-circle fa-sm disabled"></i>Job Details</button> ';
        var b_resubmit =    '<button class="btn jobviewer_menu" name="b_resubmit" disabled="true"  onclick="click_b_header(this.name)"><i style = "margin-right:3px" class= "fas fa-retweet fa-sm disabled"  ></i>Resubmit</button> ';
        var b_delall =      '<button class="btn jobviewer_menu" name="b_delall" onclick="click_b_header(this.name)"><i style = "margin-right:3px" class= "fas fa-trash-alt fa-sm" ></i>Delete All</button> ';
        var b_delsel =      '<button class="btn jobviewer_menu" name="b_delsel" disabled="true" onclick="click_b_header(this.name)"><i style = "margin-right:3px" class= "fas fa-trash-alt fa-sm disabled" ></i>Delete Selected</button> ';
        var arr_all_in_b = [b_details,b_resubmit,b_delall,b_delsel];
        
        //check user permissions
        var _filter = _getObjectByValue(m_userpermissions,"FILTER_JOBSTATUS_BUTTONS");
        if (_filter.length > 0){
            
            var regex = new RegExp( _filter[0]["value"]["filter"], 'gi' );
            console.log("Displaying filtered list of buttons, regex: ", regex);
            
            //add filtered btns to Running jobgrid
            for (_id=0;_id<arr_all_in_a.length;_id++){
                if (arr_all_in_a[_id].match(regex)){
                    _appendtext('a',arr_all_in_a[_id])
                }
            }
            //no filter, add filtered btns to History jobgrid
            for (_id=0;_id<arr_all_in_b.length;_id++){
                if (arr_all_in_b[_id].match(regex)){
                    _appendtext('b',arr_all_in_b[_id])
                }
            }
        }else{
            //just render all btns
            console.log("Displaying unfiltered list of menu buttons" )
            _appendtext('b',arr_all_in_a.join("") );
            _appendtext('c', b_details + b_resubmit + b_delall + b_delsel);
        }
        function _appendtext (cellid, to_append){//helper
            mainLayout.cells(cellid).setText(mainLayout.cells(cellid).getText() + to_append);
        }

    }

    function _getObjectByValue(object, value) {//helper
        var to_return = [];
        for (var _idx in object){
           var _v =  object[_idx]["key"];
           if (_v == value){
            to_return.push(object[_idx]);
           }
        }
        return to_return;
    }
    
    function applyFilter(filtername,filtervalue){
        for (i = 0; i < $("input[name=search]").length; i++) {
            var input = $("input[name=search]")[i];     
            var keyname = input.placeholder.toLowerCase();
            if(keyname.match(filtername.toLowerCase())){
                console.log("Applying filter from URL: " + filtername)
                input.value = filtervalue;
                 var e = $.Event( "keyup", { keyCode: 13 } );
                 $(input).trigger(e);
            }
         }  
    }

    /* build basic page layout and init periodic job loading*/
    function init() {
        
        //search params from URL go to their corresponding search inputs
        var query = window.location.search.substring(1);
        query = parse_query_string(query);
        m_query = query;
        console.log("Querystring",query)
        //insert filter from url into search text fields
        for (var filtername in query) {
            if (query.hasOwnProperty(filtername) && filtername != "") {
                console.log(filtername + " -> " + query[filtername]);
                applyFilter(filtername, query[filtername])
            }
        }

        //kick off DB maintenance verytime a client opens the UI - fire and forget TODO: kick off from server instead of from client
        $.get("/deleteoldrecords");

        //check if html5 features supported
        if (typeof(Storage) !== "undefined") {} else {
            dhtmlx.message("ERROR, no html5 store support, cannot save view state")
        }

        mainLayout = new dhtmlXLayoutObject({
            parent: document.body,
            pattern: "3L",
            cells: [
					{id: "a", text: "Workflow Filter", collapsed_text: "<span id='workflow_filter_header_collaped' style='display:flex;cursor:pointer'><b>Workflows</b></span>"},
					{id: "b", text: "Running"},
					{id: "c", text: "Finished"}
				]
        });

        mainLayout.cells("a").showInnerScroll()
        mainLayout.cells("a").setMinWidth(150);
        mainLayout.cells("a").setWidth(350);
        mainLayout.cells("a").collapse(); 
		
		if (m_serverconfig["alternate-server"] != true ){
			buildWorfklowTree(); //load workflows
			mainLayout.cells("a").setText('<span id="workflow_filter_header_expanded" style="margin-right:15px;font-size:13px;display:flex" >Workflows</span>');
		}else{

			mainLayout.cells("a").setCollapsedText("");
			mainLayout.cells("a").hideArrow();
		}
        
		mainLayout.cells("a").setText('<span id="workflow_filter_header_expanded" style="margin-right:15px;font-size:13px;display:flex" >Workflows</span>');
        mainLayout.cells("b").setText('<span style="margin-right:15px;font-size:13px" >Running</span>');
        mainLayout.cells("c").setText('<span style="margin-right:15px;font-size:13px" >Finished</span>');

        
        //attach mouseclick event to exand workflow cell on click onto whole bar instead of < icon only
        $('#workflow_filter_header_collaped').click(()=>{
            mainLayout.cells("a").expand()
            restoreLayoutSizes(mainLayout, "mainLayout");
        });
        mainLayout.attachEvent("onCollapse", function(name){
                $('#workflow_filter_header_collaped').click(()=>{
                    mainLayout.cells("a").expand()
                    restoreLayoutSizes(mainLayout, "mainLayout");
                });
                localStorage.setItem("mainLayout_c_collapsed", "true");
                console.log("saving collapsed state")
        });
        mainLayout.attachEvent("onExpand", function(name){
                localStorage.setItem("mainLayout_c_collapsed", "false");
        });
        
  
        
        mainLayout.cells("c").setWidth($(document).width() / 3);
        //mainLayout.cells("c").setText("Finished");
        mainLayout.cells("b").setHeight($(document).height() / 3.5);
        restoreLayoutSizes(mainLayout, "mainLayout");


        
        //attach grids
        mainLayout.cells("c").attachObject("history_div");
        mainLayout.cells("c").showInnerScroll();
        mainLayout.cells("b").attachObject("active_div");
        mainLayout.cells("b").showInnerScroll();
        
        
        //url parameter hideheaders
        if (query["hideheaders"]){
            mainLayout.cells("b"). hideHeader();
            mainLayout.cells("c"). hideHeader();
        }

        //ur param hideactive
        if (query["hideactive"]){
            mainLayout.cells("b").collapse()
            mainLayout.cells("b").hideArrow();
            $('.dhx_cell_layout.dhxlayout_collapsed_h')[0].style.height = "0px";          
        }
        if (query["hidehistory"]){
            mainLayout.cells("c").collapse()
            mainLayout.cells("c").hideArrow();
            $('.dhx_cell_layout.dhxlayout_collapsed_h')[0].style.height = "0px";           
        }
        //menu text and buttons
        addMenuButtons();
        
        mainLayout.attachEvent("onPanelResizeFinish", function() {
            saveLayoutSizes(mainLayout, "mainLayout");
        });

        //restore last sort order for active jobs
        try{
            m_lastsortelementid = JSON.parse(localStorage.getItem("m_lastsortelementid"));
            m_lastsortdir = JSON.parse(localStorage.getItem("m_lastsortdir"));
        }catch(ex){
            console.log("No Sorting stored in client cache, will apply default sort order.")
        }
        if (!m_lastsortelementid || !m_lastsortdir || typeof(m_lastsortelementid) != "object" || typeof(m_lastsortdir) != "object") {
            m_lastsortelementid = {}
            m_lastsortdir = {}
            m_lastsortelementid["treetable_active"] = "active-state";
            m_lastsortdir["treetable_active"] = "asc";
			m_lastsortelementid["treetable_history"] = "job_start";
            m_lastsortdir["treetable_history"] = "asc";
            console.log("Applying default sorting for active and history grid")
        } else {
            console.log("Applying stored sorting for active grid", m_lastsortelementid["treetable_active"], m_lastsortdir["treetable_active"])
        }
		
        //    mainLayout.cells("b").progressOn();

        socket.on('newhistoryjob', function(msg) {
           
            if (applyWorkflowFilter(msg) == false) {
            //apply user permissions
				return;
            }
			if (history_search_is_active()){
			//apply search if any
				if (!search_history_check_new_row(msg)){
					return;
				}
			}
            //server informs us about new history jobs in db, if there are new, we fetch them
            var rootNode = $("#treetable_history").fancytree("getRootNode");

            var existing_node = rootNode.tree.getNodeByKey(msg.key)
            //store the position of existing nodes (for update)
            if (existing_node) {
                existing_node.fromDict(msg);
                return;
            }
			
            firstnode = rootNode.findFirst("")
            if (firstnode) {
                if (firstnode.extraClasses == "odd_dhx_skyblue") {
                    msg.extraClasses = "ev_dhx_skyblue";
                } else {
                    msg.extraClasses = "odd_dhx_skyblue";
                }
            }

			//cleanup too many nodes to support running the webinterface for indefinite time
			while(rootNode.countChildren() > m_max_history_gridrows){
				rootNode.getLastChild().remove();
			}
            
			//add new node
            var childNode = rootNode.addChildren(msg, $("#treetable_history").fancytree("getRootNode").getFirstChild());
            //take care about grid sorting
            sortGrid("treetable_history", m_lastsortelementid["treetable_history"], m_lastsortdir["treetable_history"]);
			
			
        });

        socket.on('incomingjobs', function(msg) {
           
            if (JSON.parse(msg)) {
                var q_obj = (JSON.parse(msg));
                for (i=0;i<q_obj.length;i++){
                    //convert file time to time of user perspective
                     console.log(new Date(q_obj[i]["job_start"]  ))//TODO: Date dont work in FF und IE
                    q_obj[i]["job_start"] = new Date(q_obj[i]["job_start"] + " UTC" );//if do not do this, time will be off from timezone
                   
                    q_obj[i]["job_start"] = new Date(q_obj[i]["job_start"] + " UTC" ).toISOString().replace("T"," ").replace(/\..*/,""); 
                    
                }
                addActiveJobsToGrid(runningJobGrid, q_obj, "Incoming");
            }
            mainLayout.cells("b").progressOff();
        });
		
        socket.on('queuedjobs', function(msg) {
            if (JSON.parse(msg)) {
                var q_obj = (JSON.parse(msg))
                addActiveJobsToGrid(runningJobGrid, q_obj, "Queued");
            }
            mainLayout.cells("b").progressOff();
        });
        socket.on('activejobs', function(msg) {
            addActiveJobsToGrid(runningJobGrid, JSON.parse(msg), "Active");
            mainLayout.cells("b").progressOff();
        });
        socket.on('error', function(msg) {
            dhtmlx.message(msg);
        });
        socket.on('msg', function(msg) {
            dhtmlx.message(msg);
        });

        //deprecated!!!
        if (!JSON.parse(m_serverconfig['STATIC_USE_PROXY_URL'])) {
            alert("running in pull mode, this should not happen")
            window.setInterval(function() {
                getQueuedJobs(runningJobGrid)
            }, parseInt(3000));
            window.setInterval(function() {
                getActiveJobs(runningJobGrid)
            }, parseInt(3000));
            window.setInterval(function() {
                getFinishedJobs(finishedJobGrid)
            }, parseInt(3000));
            getQueuedJobs(runningJobGrid);
            getActiveJobs(runningJobGrid);
            getFinishedJobs(finishedJobGrid);
        }


        $('input[type="search"]').click(function(event){
        /*need to canclebubble on type search to prevent sorting*/
        
            event.stopPropagation();
        });

        buildHistoryGrid();
        buildActiveGrid();
		setInitialColumnWidths();
		attachColResizeable("#treetable_active")
		attachColResizeable("#treetable_history")

        forcejobloading();
        //sort grids
		console.log("Sortying history by ",m_lastsortelementid["treetable_history"],m_lastsortdir["treetable_history"])
        //history grid is sorted in buildHistoryGrid
        sortGrid("treetable_active", m_lastsortelementid["treetable_active"], m_lastsortdir["treetable_active"]);
		

		//workaround grips getting lost after resize: as fancytree takes a while to resize on window resize, we delay the resizing of colresizeable plugin
		window.onresize = function(){
			window.setTimeout(function(){
				attachColResizeable("#treetable_active")
				attachColResizeable("#treetable_history")
			},1500)
		};
		
    }


    function buildWorfklowTree(){

        $.ajax({
            url:  "/getworkflowlist",
            type: "GET",
            crossDomain: true,
            dataType: "json",
            success: function (response) {
                console.log("workflows",response)
                if (response['workflows'].length == 0){
                    alert("Did not get any workflows from FFASTRANS API");
                }else{
                    m_workflowArray = response['workflows'];
                    
                    mainLayout.cells("a").progressOff();
                    mainLayout.cells("a").detachObject();
                    mainLayout.cells("a").attachObject("workflow_filter_menu");
                    
                    //search button
                    $("input[name=wf_filter]").keyup(function(e){
                      var n,
                            tree = $("#workflowtree").fancytree('getTree');
                            opts = {},
                            filterFunc = tree.filterNodes,
                            match = $(this).val();
                            if(e && e.which === $.ui.keyCode.ESCAPE || $.trim(match) === ""){
                                tree.clearFilter();
                                return;
                            }
                        // Pass a string to perform case insensitive matching
                        n = filterFunc.call(tree, match, opts);
						dhtml.message("oida")
                    }).focus();
                    
                    //finally build workflow tree
                    parseWorkflows(m_workflowArray,{"selectMode":2,"dom_id":"workflowtree","extensions":["filter","multi","persist"]},on_treeWorkflowSelected,function(){/*no click evt*/});
                    var sel = $("#workflowtree").fancytree('getTree').getSelectedNodes();
                    applyWorkflowSearch(sel);
                    
                }
            },
            error: function (xhr, status) {
                mainLayout.cells("a").progressOff();
                dhtmlx.message("ERROR in getWorkflows call, possibly FFASTRANS API is offline. Or you havee an invalid expression in filter regex");
            }
        });
    }

    function applyWorkflowSearch(selectednodes){
        var a = [];
        selectednodes.forEach(function(n){           
            if (n.folder){
                //unselect folders
                console.log("unselecting folder",n.title)
                n.setSelected(false)
            }else{
                a.push(n.title);
            }
        })
     
     applyFilter("workflow",a.join("|"));
    }
    
    
    function on_treeWorkflowSelected(event, data){
        //user selected a workflow, modify workflowfilter
        
        var s = data.tree.getSelectedNodes();
        applyWorkflowSearch(s);
    }

		
	function setInitialColumnWidths(){
	
		/*only set column widths if there ar no stored ones*/
		var do_restore = true;
		if ("treetable_active" in localStorage){
			console.log("Not restoring InitialColumnwidths as it is not the first time user opened the site")
			do_restore = false;
		}
		console.log("Setting initial width percent values")
		var running_percent = m_serverconfig["STATIC_RUNNING_GRID_COL_WIDTHS_PERCENT"].split(",");
		console.log(running_percent)
		var idx = 0;
		$('#colgroup_active').children('col').each(function () {
			try{
			
				if (!running_percent[idx] && do_restore){
					$($('#colgroup_active').children('col')[idx]).css("width","4%"); //minimum width
				}
				if (running_percent[idx] && (do_restore)){
					console.log($($('#colgroup_active').children('col')[idx]),running_percent[idx])
					$($('#colgroup_active').children('col')[idx]).css("width",running_percent[idx])
				}
				if (running_percent[idx] == "0%"){
					//hide if admin config is 0%
					$($('#tr_treetable_active').children('th')[idx]).css("display","none")
				}
						
			}catch(ex){
				console.log(ex)
			}
			idx++;
		});
		
		var history_percent = m_serverconfig["STATIC_FINISHED_GRID_COL_WIDTHS_PERCENT"].split(",");
		idx = 0;
		$('#colgroup_history').children('col').each(function () {
			try{
				if (!history_percent[idx] && do_restore){
					$($('#colgroup_active').children('col')[idx]).css("width","4%"); //minimum width
				}
				if (history_percent[idx] && ( do_restore)){
					$($('#colgroup_history').children('col')[idx]).css("width",history_percent[idx])
				}
				if (history_percent[idx] == "0%"){
					$($('#tr_treetable_history').children('th')[idx]).css("display","none");
				}
			}catch(ex){		
			}
			idx++;
		});
	}
		
		

    function click_a_header(id) {
        clearSelection();
        var tree = $('#treetable_active').fancytree('getTree');
        var selected = tree.getSelectedNodes();
        if (selected.length == 0) {
            dhtmlx.alert("Please select row");
            return;
        }

        if (id == "a_details") {
			if (selected[0].data["state"] == "Queued"){
				dhtmlx.message("Sorry, no details to show for queued jobs available");
				return;
			}
            var jobid = (selected[0].data["job_id"]); //active_jobs dont have a sort_family_name
            var url = "logviewer.html?job_id=" + jobid;
            window.open(url, '_blank');
        }
        if (id == "a_abort") {
            jobCommand(selected, "abort");
        }
        if (id == "a_pause") {
            jobCommand(selected, "pause");
        }
        if (id == "a_resume") {
            jobCommand(selected, "resume");
        }
 
    }
    
    function show_options_window(){
        var dhxwins = new dhtmlXWindows();
        //dhxwins.attachViewportTo(window.parent.document.body);
        var win = dhxwins.createWindow("View Options", window.innerWidth/2, window.innerHeight/4, 600, 200);
        win.setText("View Options ");
        win.attachURL("jobviewer_pages/options.html");
        
    }

    function click_b_header(id,node) {
        //if we have node argument, we are called from context menu
        var tree = $('#treetable_history').fancytree('getTree');
        var selected = tree.getSelectedNodes();
         
        if (id == "b_opts") {
            show_options_window();
            return;
        }
        
        if (selected.length == 0 && (id != "b_delall")) {
            dhtmlx.alert("Please select row");
            return;
        }
        if (id == "b_resubmit") {
            selected.forEach(function(node) {
                resubmit_job(node["data"]["guid"]);
            })
        }
        if (id == "b_details") {
            if (selected.length == 0) {
                dhtmlx.alert("Please select row to show details");
                return;
            }
            var jobid = (selected[0].data["job_id"]); //jobid contains splitid, sort_family_name is the id of mother job without splitd
            var url = "logviewer.html?job_id=" + jobid;
            window.open(url, '_blank');
        }
        if (id == "b_delsel") {
            //delete selected jobs
            if (selected.length == 0) {
                dhtmlx.alert("Please select rows to delete ");
                return;
            }
            var array_to_delete = [];
            for (i = 0; i < selected.length; i++) {}
            selected.forEach(function(node) {
                array_to_delete.push(node.data["guid"]);
                node.remove();
            });
            socket.emit("deletejob", JSON.stringify(array_to_delete)); //note, custom structure for socket.emit messages
        }
        if (id == "b_delall") {
            //delete all jobs
            dhtmlx.confirm({
                title: "Delete ALL Jobs",
                type: "confirm-error",
                text: "Really delete ALL Jobs?",
                callback: function(yesno) {
                    if (yesno) {
                        socket.emit("deletealljobs"); //note, custom structure for socket.emit messages

                        var rootNode = $("#treetable_history").fancytree("getRootNode");
                        rootNode.removeChildren();
                    }
                } //callback
            }); //confirm
        } //delall
    }

	function attachColResizeable(tree_id){
		/*(re-) attaches colresizeable jquery plugin to given tree id
		  this must be done on window resize, otherwise the grip point is mislocated
		*/
			//destroy existing 
			$(tree_id).colResizable({
			   disable:true
			});
			//recreate
			$(tree_id).colResizable({
				resizeMode: 'fit',
				hoverCursor: "col-resize",
				dragCursor: "col-resize",
				postbackSafe: true,
				useLocalStorage: true,
				minWidth: 10,
				liveDrag: true,
				removePadding : true
			});
	}
	
    function buildActiveGrid() {

        //var sourceUrl = "testdata.xml";
        $("#treetable_active").fancytree({
            extensions: ["contextMenu","table", "gridnav", "multi"],
            icon: false,
            checkbox: false,
            titlesTabbable: true, // Add all node titles to TAB chain
            table: {
                indentation: 15,
                nodeColumnIdx: 0,
            },
            select: function(event, data) {
                if (data.node.isSelected()) {
                    data.node.addClass("rowselected");
                    toggleJobControl("#treetable_active",true);
                } else {
                    data.node.removeClass("rowselected");
                    toggleJobControl("#treetable_active",false);
                }
            },
            gridnav: {
                autofocusInput: false,
                handleCursorKeys: true
            },
            multi: { //multiselct
                mode: "",
            },
            init: function(event, data) {
                //ENABLE RESIZE COLUMNS
                console.log("TREE INIT")
				attachColResizeable("#treetable_active")

            },
            modifyChild: function(event, data) {
                //reset all odd even row colors
                var rootNode = $("#treetable_active").fancytree("getRootNode");
                var oldnodes = rootNode.children;
                for (i = 0; i < oldnodes.length; i++) {
                    if (i % 2 == 0) {
                        oldnodes[i].toggleClass("ev_dhx_skyblue", true)
                        oldnodes[i].toggleClass("odd_dhx_skyblue", false)
                    } else {
                        oldnodes[i].toggleClass("odd_dhx_skyblue", true)
                        oldnodes[i].toggleClass("ev_dhx_skyblue", false)
                    }
                }
            },
            renderColumns: function(event, data) {
                var node = data.node;
                node.addClass("act_row"); //for context menu
                if (data.node.getIndex() % 2 == 0) {
                    node.removeClass("odd_dhx_skyblue"); //apply dthmlx style to node
                    node.addClass("ev_dhx_skyblue"); //apply dthmlx style to node
                } else {
                    node.removeClass("ev_dhx_skyblue"); //apply dthmlx style to node
                    node.addClass("odd_dhx_skyblue"); //apply dthmlx style to node
                }

                $tdList = $(node.tr).find(">td");
				
				var filename_to_display = node.data.file;
				try{
					filename_to_display = (node.data.file.split("\\").pop());
					
				}catch(ex){
					alert(ex)
				}
				
                $tdList.eq(1).html("<div class='celltext' title='"+ node.data.workflow +"'>" + node.data.workflow + "</div>"); //.addClass("alignRight");
                $tdList.eq(2).html("<div class='celltext'>" + node.data.job_start + "</div>");
                $tdList.eq(3).html("<div class='celltext_rtl'><bdi>" + filename_to_display + "</bdi></div>");
                $tdList.eq(4).html("<div class='celltext'>" + node.data.proc + "@" + node.data.host + "</div>");
                $tdList.eq(5).html("<div class='celltext'>" + node.data.status + "</div>");
                $tdList.eq(6).html('<div class="progressbar" style=" width:' + node.data.progress + '%">' + node.data.progress + '% ' + node.data.steps.replace(/ /g, "") + '</div>');

				//hide td if needed
				var active_percent = m_serverconfig["STATIC_RUNNING_GRID_COL_WIDTHS_PERCENT"].split(",");
				for(i=0;i<active_percent.length;i++){
					if (active_percent[i] == "0%"){
						$tdList.eq(i).css("display","none")
					}
				}

                data.tree.getRootNode().sortChildren(function(a, b) {
                    return (a.data.state.localeCompare(b.data.state))
                }, true);

            },
            postProcess: function(event, data) {
                // transform gethistoryjobsajax result into tree compatible
                // data is a treegrid specific object
                data["result"] = data["response"]["data"] //setting data["result"] means override the originally loaded data
				
            },
            dblclick: function(event, data) {},
            contextMenu: {
                selector: "act_row",
                menu: getContextMenuHistoryGrid( 
                    {   
                        "details": {
                            "name": "Job Details"
                        },
                        "prio": {
                            "name": "Priority",
                            "items": {
                                "prio_0": { "name": "0 (Low)" },
                                "prio_1": { "name": "1" },
                                "prio_2": { "name": "2" },
                                "prio_3": { "name": "3" },
                                "prio_4": { "name": "4 (High)" }
                            }
                        },
                        '<i style = "margin-right:3px" class= "fas fa-pause fa-sm" ></i> pause': {
                            "name": "Pause"
                        },
                        "resume": {
                            "name": "Resume"
                        },                        
                        "abort": {
                            "name": "Abort"
                        }
                    }) ,
                    actions: function(node, action, options) {
                        console.log("action: ", action)
                        clearSelection(); //disable browser internal line selection if user selected multiple rows using shift. TODO: catch shift globally and do this
                        var tree = $('#treetable_active').fancytree('getTree');
                        var selected = tree.getSelectedNodes();
                        $.extend(selected,node);
                        if (selected.length == 0 && !node ) {
                            dhtmlx.alert("Please select row");
                            return;
                        }
                        if (action == "details") {
                            var jobid = (node.data["job_id"]); //jobid contains splitid, sort_family_name is the id of mother job without splitd
                            var url = "logviewer.html?job_id=" + jobid;
                            window.open(url, '_blank');
                        }
                        if (action.indexOf("resume") != -1) {
                           console.log(selected)
                           jobCommand(selected, "resume");
                        }
                        if (action.indexOf("abort") != -1) {
                           console.log(selected)
                           jobCommand(selected, "abort");
                        }
                        if (action.indexOf("pause") != -1) {
                           console.log(selected)
                           jobCommand(selected, "pause");
                        }
                        if (action.indexOf("prio") != -1){
                           var newprio = action.split("_")[1];
                           jobCommand(selected, "priority", newprio);
                        }
                        

                    }
                }//contextmenu
            

        })

    }

    function filterHistoryList(the_list) {
        
        var filtered = the_list;
        for (i = 0; i < m_userpermissions.length; i++) {
            if (m_userpermissions[i]["key"] == "FILTER_WORKFLOW_NAME") {
                if (filtered == the_list) {
                    filtered = [];
                }
                for (idx = 0; idx < the_list.length; idx++) {
                    var name = the_list[idx]["workflow"];
                    var regex = new RegExp(m_userpermissions[i]["value"]["filter"], 'gi');
                    if (name.match(regex)) {
                        filtered.push(the_list[idx]);
                    }
                }
            }
        }
        return filtered;

    }

    function getContextMenuHistoryGrid(allpossible){
        //opens context menu
        
        <!-- try{//special code to mark rightlcicked node as selected -->
            <!-- console.log("trying") -->
            <!-- var tree = $('#treetable_history').fancytree('getTree'); -->
            <!-- var selected = tree.getSelectedNodes(); -->
            <!-- console.log("selected count: ", selected.length) -->
        <!-- }catch(ex){} -->
        
        var contextmenu = {};
        var _filter = _getObjectByValue(m_userpermissions,"FILTER_JOBSTATUS_BUTTONS");
        if (_filter.length > 0){
            var regex = new RegExp( _filter[0]["value"]["filter"], 'gi' );
            console.log("Displaying filtered list of buttons, regex: ", regex);
            for (var _idx in allpossible){
               if (allpossible[_idx]){
                    if (allpossible[_idx].name.match(regex)){
                        console.log(allpossible[_idx]);
                        var newitem = {};
                        newitem[_idx] = allpossible[_idx];
                        $.extend(contextmenu, newitem);
                        console.log(contextmenu);
                    }
               } 
            }
            return contextmenu;
        }else{
            //just render all btns
            console.log("Displaying unfiltered list of menu buttons" );
            contextmenu = allpossible;
            return contextmenu;
        }
    }
    
    function buildHistoryGrid() {
        
        var filterobj = {};
			for (i = 0; i < $("input[name=search]").length; i++) {
                var input = $("input[name=search]")[i];
                searchfor = $.trim(input.value);
                var keyname = input.placeholder.toLowerCase();
                
                if (searchfor) {
                    filterobj[keyname]= searchfor;
                
                }
            }
        
        
        var sourceUrl = "/gethistoryjobsajax_treegrid?filtercol=job_end&direction=des&count=200&filterobj="+JSON.stringify(filterobj);
        //var sourceUrl = "testdata.xml";
        $("#treetable_history").fancytree({
            extensions: ["contextMenu", "table", "gridnav", "multi"],
            checkbox: false,
            titlesTabbable: false, // Add all node titles to TAB chain
            source: {
                url: sourceUrl,
                cache: true,
            },
            icon: false,
            multi: { //multiselct
                mode: ""
            },
			
            modifyChild: function(event, data) {
                
                //reset all odd even row colors
                var rootNode = $("#treetable_history").fancytree("getRootNode");
                var oldnodes = rootNode.children;

                for (i = 0; i < oldnodes.length; i++) {
                    if (i % 2 == 0) {
                        oldnodes[i].toggleClass("ev_dhx_skyblue", false)
                        oldnodes[i].toggleClass("odd_dhx_skyblue", true)
                    } else {
                        oldnodes[i].toggleClass("odd_dhx_skyblue", false)
                        oldnodes[i].toggleClass("ev_dhx_skyblue", true)
                    }
                }
            },

            renderColumns: function(event, data) {
                
                
                var node = data.node;
                
                if (data.node.extraClasses == null) { //need to do this whenever rowcount changes -->
                    if (data.node.getIndex() % 2 == 0) {
                        //node.removeClass = ("odd_dhx_skyblue");//apply dthmlx style to node
                        node.toggleClass("ev_dhx_skyblue"); //apply dthmlx style to node
                    } else {
                        //node.removeClass = ("ev_dhx_skyblue");//apply dthmlx style to node
                        node.toggleClass("odd_dhx_skyblue"); //apply dthmlx style to node
                    }
                }
                
                node.addClass("hist_row"); //for context menu
                if (localStorage.getItem("jobviewer_showrowcolors_history") != "false"){
                    node.addClass("css_jobviewer_history_row_status_"+data.node["title"]); //for context menu
                }
                
                
                $tdList = $(node.tr).find(">td");

                // (index #0 is rendered by fancytree (title node))
                //$tdList.eq(0).text(node.data.state);
                $tdList.eq(1).html("<div class='celltext' title='"+ node.data.workflow +"'>" + node.data.workflow + "</div>"); //.addClass("alignRight");
                $tdList.eq(2).html("<div class='celltext'>" + node.data.job_start + "</div>");
                $tdList.eq(3).html("<div class='celltext'>" + node.data.duration + "</div>");
                $tdList.eq(4).html("<div class='celltext'>" + node.data.job_end + "</div>");
                $tdList.eq(5).html("<div class='celltext_rtl'><bdi>" + node.data.file + "</bdi></div>");
                
                var outcome = node.data.outcome.substring(0, 1000);
                
                if (outcome.length == 10000) {
                    dhtmlx.message("Detected oversized outcome in job, consider deleting it.\nFile: " + node.data.file + " \nDate Start: " + node.data.job_start);
                    outcome += " (text was truncated by webinterace...) "
                }
                
                $tdList.eq(6).html("<div class='celltext' title='"+outcome+"'>" +outcome + "</div>"); //outcome can be lengthy
                
				var percent = m_serverconfig["STATIC_FINISHED_GRID_COL_WIDTHS_PERCENT"].split(",");
				for(i=0;i<percent.length;i++){
					if (percent[i] == "0%"){
						console.log("Hiding finished grid col",$tdList.eq(i))
						$tdList.eq(i).css("display","none")
						//console.log($tdList.eq(i))
					}
				}
				
            },
            init: function(event, data) {
                //ENABLE RESIZE COLUMNS
                attachColResizeable("#treetable_history");
            },
            postProcess: function(event, data) {
				console.log("History grid postproc")
                // transform gethistoryjobsajax result into tree compatible
                // data is a treegrid specific object
                data["result"] = filterHistoryList(data["response"]["data"]) //setting data["result"] means override the originally loaded data
				sortGrid("treetable_history", m_lastsortelementid["treetable_history"], m_lastsortdir["treetable_history"]);
            },
            table: {
                indentation: 15,
                nodeColumnIdx: 0,
            },
            gridnav: {
                autofocusInput: false,
                handleCursorKeys: true
            },
            select: function(event, data) {
                if (data.node.isSelected()) {
                    data.node.addClass("rowselected");
                    toggleJobControl("#treetable_history",true);
                } else {
                    data.node.removeClass("rowselected");
                    toggleJobControl("#treetable_history",true);
                }
            },
            contextMenu: {
                selector: "hist_row",
                menu: getContextMenuHistoryGrid( 
                    {
                        "details": {
                            "name": "Job Details"
                        },
                        "resubmit": {
                            "name": "Resubmit from Start"
                        },
                        "delsel": {
                            "name": "Delete selected"
                        },
                    }) ,
                actions: function(node, action, options) {
                        
                        clearSelection(); //disable browser internal line selection if user selected multiple rows using shift. TODO: catch shift globally and do this
                        var tree = $('#treetable_history').fancytree('getTree');
                        var selected = tree.getSelectedNodes();
                         $.extend(selected,node);
                         console.log(action,selected)
                        if (action.indexOf( "details") != -1) {
                            var jobid = (node.data["job_id"]); //jobid contains splitid, sort_family_name is the id of mother job without splitd
                            var url = "logviewer.html?job_id=" + jobid;
                            window.open(url, '_blank');
                        }
                        if (action == "delsel") {
                            node.setSelected();
                            click_b_header("b_delsel",node);
                        }
                        if (action == "resubmit") {
                            node.setSelected();
                            click_b_header("b_resubmit",node)
                        }

                    }
                }//contextmenu
            
        })

        //search btn
        $('input[name=search]').bind("enterKey", search_history_grid);

        $("input[name=search]").keyup(function(e) {
            if (e.keyCode == 13) {
                $(this).trigger("enterKey");
            }
        });

    } //buildhistorygrid

	function search_history_check_new_row(new_row){
           
		/* called if search is active and new history job arrives, we need to apply the searchfields manually*/
            var show_row = true;
			for (i = 0; i < $("input[name=search]").length; i++) {
                var input = $("input[name=search]")[i];
                searchfor = $.trim(input.value);
                var keyname = input.placeholder.toLowerCase();
                if(keyname.match(/start|end/)){
                    keyname = "job_" + keyname;
                }
                if (searchfor) {
					console.log("Checking if new row field ", keyname, "value:",new_row[keyname],"matches",searchfor)
                    var regex = new RegExp(searchfor, 'gi');

                    if (new_row[keyname].match(regex)){
                        console.log("match",regex)
						show_row = show_row == false ? show_row : true;
					}else{
                        console.log("no match",regex)
                        show_row = show_row == false ? show_row : false;
                    }
                }else{
                    show_row = show_row == false ? show_row : true;
                }
            }
            
            return show_row;

	}
	
	function history_search_is_active(){
		/* is a filter active? */
			var searchCount = 0;
			for (i = 0; i < $("input[name=search]").length; i++) {
                var input = $("input[name=search]")[i];
                match = $.trim(input.value);
                if (match) {
                    searchCount++;
                }
            }
            console.log("History Search num of filters:",searchCount)
			return searchCount;
	}
	
	function search_history_grid(btn_event){
		 var search_obj = {};
            for (i = 0; i < $("input[name=search]").length; i++) {
                var input = $("input[name=search]")[i];
                match = $.trim(input.value);
                var keyname = input.placeholder.toLowerCase();
                if(keyname.match(/start|end/)){
                    keyname = "job_" + keyname;
                }
                if (match) {
                    search_obj[keyname] = (match)
                }
            }
            var tree = $('#treetable_history').fancytree('getTree');
            tree.reload({
                url: "/gethistoryjobsajax_treegrid?filtercol=job_end&direction=des&count="+m_max_history_gridrows+"&filterobj=" + JSON.stringify(search_obj),
                cache: false
            });
	}

    function delete_jobs(array_of_rows) {

        var selectedRowIds = runningJobGrid.getSelectedRowId().split(',');
        selectedRowIds.forEach(function(rId) {
            var jobObj = runningJobGrid.getUserData(rId, "jobobject");
            var splitid = parseInt(runningJobGrid.cells(rId, 9).getValue());
            var postBody = {
                "action": pause,
                "split": splitid
            };
            socket.emit("pausejob", JSON.stringify({
                "id": jobObj.job_id,
                "body": postBody
            })); //note, custom structure for socket.emit messages
            dhtmlx.message("Command " + pause + " emitted:" + JSON.stringify(postBody))
        })
    }

    function saveLayoutSizes(dhxLayout, name) {
        //store layout cells height and with into html5 storage (in percentage of document height)
        var aw = (dhxLayout.cells("b").getWidth() / document.body.scrollWidth);
        var ah = (dhxLayout.cells("b").getHeight() / document.body.scrollHeight);
        var bw = (dhxLayout.cells("c").getWidth() / document.body.scrollWidth);
        var bh = (dhxLayout.cells("c").getHeight() / document.body.scrollHeight);
        var cw = (dhxLayout.cells("a").getWidth() / document.body.scrollWidth);
        var ch = (dhxLayout.cells("a").getHeight() / document.body.scrollHeight);
        localStorage.setItem(name + "_aw", aw);
        localStorage.setItem(name + "_ah", ah);
        localStorage.setItem(name + "_bw", bw);
        localStorage.setItem(name + "_bh", bh);
        if (!dhxLayout.cells("a").isCollapsed()){
            localStorage.setItem(name + "_cw", cw);
            localStorage.setItem(name + "_ch", ch);
        }
        localStorage.setItem(name + "_c_collapsed", dhxLayout.cells("a").isCollapsed());
    }

    function restoreLayoutSizes(dhxLayout, name) {
        if (localStorage.getItem(name + "_aw")) {
            if (localStorage.getItem(name + "_c_collapsed") == "false"){
                dhxLayout.cells("a").expand();
            }
            var aw = localStorage.getItem(name + "_aw");
            var ah = localStorage.getItem(name + "_ah");
            var bw = localStorage.getItem(name + "_bw");
            var bh = localStorage.getItem(name + "_bh");
            var cw = localStorage.getItem(name + "_cw");
            var ch = localStorage.getItem(name + "_ch");
            dhxLayout.cells("b").setWidth(aw * document.body.scrollWidth);
            dhxLayout.cells("b").setHeight(ah * document.body.scrollHeight);
            dhxLayout.cells("c").setWidth(bw * document.body.scrollWidth);
            dhxLayout.cells("c").setHeight(bh * document.body.scrollHeight);
            if (dhxLayout.cells("a").isCollapsed() == false){
                console.log("CW",cw)
                dhxLayout.cells("a").setWidth(cw * document.body.scrollWidth);
                dhxLayout.cells("a").setHeight(ch * document.body.scrollHeight);
            }

        }
        
    }


    function resubmit_job(job_id) {
        //get all workflows from server and start main with the workflow of interest
        job_id = job_id.split("~")[0];
        var _url = "/getjobdetails?jobid=" + job_id;
        $.ajax({
            url: build_new_api_url(_url),
            type: "GET",
            crossDomain: true,
            success: function(response) {

                if (response['wf_object'].length == 0) {
                    alert("Did not get any workflow in job from FFASTRANS API");
                } else {
                    var postBody = {};
                    postBody.start_proc = response["nodes"]["start"]["id"];
                    postBody.wf_id = response["workflow"]["id"];
                    postBody.inputfile = response["sources"]["localized_file"];
                    postBody.variables = response["variables"];
                    $.ajax({
                        url: buildUrl(m_serverconfig['STATIC_START_JOB_URL']),
                        type: "POST",
                        crossDomain: true,
                        data: JSON.stringify(postBody),
                        success: function(response) {
                            dhtmlx.message(postBody.inputfile + " was submitted")
                        },
                        error: function(xhr, status) {
                            dhtmlx.alert("Error submitting workflow: " + xhr.responseText);
                        }
                    });
                }
            },
            error: function(xhr, status) {
                alert("ERROR getting workflow of job " + job_id + ", possibly FFASTRANS API is offline. ");
            }
        });
    }

    function pauseResumeJob(pause, httpMethod) {
        //Emits socket.io comman to webserver (the api request is made on the webserver not the client) pause is set to either pause or resume.
        if (!runningJobGrid.getSelectedRowId()) {
            dhtmlx.alert("Please select a Job to " + pause);
            return;
        }
        var selectedRowIds = runningJobGrid.getSelectedRowId().split(',');
        selectedRowIds.forEach(function(rId) {
            var jobObj = runningJobGrid.getUserData(rId, "jobobject");
            var splitid = parseInt(runningJobGrid.cells(rId, 9).getValue());
            var postBody = {
                "action": pause,
                "split": splitid
            };
            socket.emit("pausejob", JSON.stringify({
                "id": jobObj.job_id,
                "body": postBody
            })); //note, custom structure for socket.emit messages
            dhtmlx.message("Command " + pause + " emitted:" + JSON.stringify(postBody))
        })
    }

    function jobCommand(fancy_node_array, action, value) {
        //only available in ffastrans 9.4>//TODO: wait for the new version call, then do version detection
        console.log("jobcommand", fancy_node_array,action,value)
        fancy_node_array.forEach(function(node) {
            if (node["data"]["state"] == "Queued" || node["data"]["state"] == "Incoming") {
                dhtmlx.message("Sorry, "+node["data"]["state"]+" Jobs cannot be controlled yet");
                return;
            }
            var postBody = {
                "action": action,
                "split_id": node.data.split_id
            };
            if (value){
                postBody["value"] = value;
            }
            $.ajax({
                url: ("/proxy" + m_serverconfig['STATIC_START_JOB_URL']) + node.data.job_id,
                type: "PUT",
                context: this,
                data: JSON.stringify(postBody),
                success: function(response) {
                    dhtmlx.message("Success " + action + " " + node.data.job_id);
                },
                error: function(xhr, status) {
                    dhtmlx.message("ERROR aborting job, contact developer. Status:" + status);
                }
            });
        })

    }

    function abortJob() {
        if (!runningJobGrid.getSelectedRowId()) {
            dhtmlx.alert("Please select a Job to abort");
            return;
        }
        var selectedRowIds = runningJobGrid.getSelectedRowId().split(',');
        selectedRowIds.forEach(function(rId) {
            var rowId = rId;
            var jobObj = runningJobGrid.getUserData(rowId, "jobobject");
            $.ajax({
                url: ("/proxy" + m_serverconfig['STATIC_START_JOB_URL']) + jobObj.job_id,
                type: "DELETE",
                context: this,
                success: function(response) {
                    dhtmlx.message("Aborted " + jobObj.job_id);
                },
                error: function(xhr, status) {
                    dhtmlx.message("ERROR aborting job, contact developer. Status:" + status);
                }
            });
        }) //foreachjob
    }

    function getQueuedJobs(targetGridObj) {

        $.ajax({
            url: buildUrl(m_serverconfig['STATIC_GET_QUEUED_JOBS_URL']),
            type: "GET",
            crossDomain: true,
            dataType: "json",
            context: this,
            success: function(response) {
                mainLayout.cells("b").progressOff();
            },
            error: function(xhr, status) {
                dhtmlx.message("ERROR getting queued jobs, possibly FFASTRANS API is offline.  ");
            }
        });
    }

    function applyWorkflowFilter(o_job) {
        
        
        //returns true or false based on userpermission job filter
        for (i = 0; i < m_userpermissions.length; i++) { //iterate all permissions
            if (m_userpermissions[i]["key"] == "FILTER_WORKFLOW_NAME") {

                var regex = new RegExp(m_userpermissions[i]["value"]["filter"], 'gi');
                if (o_job["workflow"].match(regex)) {

                    return true;
                } else {
                    return false;
                }
            }
        }
        return true; //if there is no filter, render all jobs
    }

    function addActiveJobsToGrid(targetGridObj, jobArray, qstate) {
		
        var rootNode = $("#treetable_active").fancytree("getRootNode");
        var tree = $("#treetable_active").fancytree("getTree");
        //add or update new jobs
        var activeJobIds = [];
        for (y = 0; y < jobArray.length; y++) {
            if (!search_history_check_new_row(jobArray[y])){
                continue;
            }
            if (applyWorkflowFilter(jobArray[y]) == false) {
                continue;
            }

            var key = jobArray[y]["key"].toString();
            activeJobIds.push(key);
            
            var existing = tree.getNodeByKey(key);
            
            if (existing) {
				//console.log("Node exists, updating",jobArray[y])
				//console.log("Node exists, existing",existing)
                var needrender = false;
                if (JSON.stringify(existing.data) != JSON.stringify(jobArray[y])){
                    needrender = true;
                }
                existing.data = jobArray[y];
				existing.title = jobArray[y]["title"]
                if (needrender){
                    existing.renderTitle(); //forces reload of node
                }
            } else {
                rootNode.addChildren(jobArray[y]);
            }
        }
        
        //remove orphand
        var oldnodes = rootNode.children;
        if (oldnodes) {
            for (a = 0; a < oldnodes.length; a++) {
                if (oldnodes[a]["data"]["state"] == qstate) {
                    if (activeJobIds.indexOf(oldnodes[a]["key"]) == -1) {
                        oldnodes[a].remove();
                    }
                }

            }
        }
        //take care about grid sorting
        sortGrid("treetable_active", m_lastsortelementid["treetable_active"], m_lastsortdir["treetable_active"]);
        
    }

    /* HELPERS */
    function hashCode(string) {
        //this creates a hash from a stringified object, it is used to workaround and create missing jobids from ffastrans version 0.9.3
        var hash = 0,
            i,
            chr;
        if (string.length === 0)
            return hash;
        for (i = 0; i < string.length; i++) {
            chr = string.charCodeAt(i);
            hash = ((hash << 5) - hash) + chr;
            hash |= 0; // Convert to 32bit integer
        }
        return hash;
    };

    function getDurationStringFromDates(start_date, end_date) {
        var delta = Math.abs(new Date(end_date) - new Date(start_date)) / 1000; // get total seconds between the times
        var days = Math.floor(delta / 86400); // calculate (and subtract) whole days
        delta -= days * 86400; // calculate (and subtract) whole hours
        var hours = Math.floor(delta / 3600) % 24;
        delta -= hours * 3600; // calculate (and subtract) whole minutes
        var minutes = Math.floor(delta / 60) % 60;
        delta -= minutes * 60; // what's left is seconds
        var seconds = delta % 60; // in theory the modulus is not required
        return pad(hours) + ":" + pad(minutes) + ":" + pad(seconds);
    }

    function pad(n, z) { //add leading zero if there is none
        z = z || '0';
        n = n + '';
        return n.length >= 2 ? n : new Array(2 - n.length + 1).join(z) + n;
    }

    function configureJobGrid(dhtmlxGridObj) {
        //todo: this is only for activejobgrid
        dhtmlxGridObj.setImagePath("../dependencies/dhtmlx/imgs");
        //dhtmlxGridObj.attachHeader("#text_filter,#text_filter,#text_filter,#text_filter,#text_filter,#text_filter,#text_filter,#text_filter,#text_filter,#text_filter,#text_filter,#text_filter");
        dhtmlxGridObj.setColAlign("left,left,left,left,left,left,left,left,left,left,left"); //the alignment of columns
        dhtmlxGridObj.setColTypes("ro,ed,ed,ed,ed,ro,ed,ed,ed,ed,ed,ed,ed"); //the types of columns
        dhtmlxGridObj.setColSorting("str,str,str,str,str,str,str,str,str,str,str,str"); //the sorting types
        dhtmlxGridObj.enableMultiselect(true);
        dhtmlxGridObj.init(); //finishes initialization and renders the grid on the page
    }

    function buildUrl(what) {
        if (JSON.parse(m_serverconfig['STATIC_USE_PROXY_URL'])) {
            return "/proxy" + what;
        } else {
            var _url = "http://" + m_serverconfig['STATIC_API_HOST'] + ":" + m_serverconfig['STATIC_API_PORT'] + what;
            return _url;
        }
        //old, delete at next iteration
    }

    /* NO PROXY MODE */
    function getQueuedJobs(targetGridObj) {
        $.ajax({
            url: buildUrl(m_serverconfig['STATIC_GET_QUEUED_JOBS_URL']),
            type: "GET",
            crossDomain: true,
            dataType: "json",
            context: this,
            success: function(response) {
                addQueuedJobsToGrid(targetGridObj, response.queue);
                mainLayout.cells("b").progressOff();
            },
            error: function(xhr, status) {
                dhtmlx.message("ERROR getting queued jobs, possibly FFASTRANS API is offline.  ");
            }
        });
    }

    function getActiveJobs(targetGridObj) {
        $.ajax({
            url: buildUrl(m_serverconfig['STATIC_GET_RUNNING_JOBS_URL']),
            type: "GET",
            crossDomain: true,
            dataType: "json",
            context: this,
            success: function(response) {
                addActiveJobsToGrid(targetGridObj, response.jobs);
                mainLayout.cells("b").progressOff();
            },
            error: function(xhr, status) {
                dhtmlx.message("ERROR getting jobs, possibly FFASTRANS API is offline.  ");
            }
        });
    }

    function getFinishedJobs(targetGridObj) {

        $.ajax({
            url: buildUrl(m_serverconfig['STATIC_GET_FINISHED_JOBS_URL']),
            type: "GET",
            crossDomain: true,
            dataType: "json",
            context: this,
            success: function(response) {

                addHistoryJobsToGrid(targetGridObj, response.history);
                mainLayout.cells("c").progressOff();
            },
            error: function(xhr, status) {
                dhtmlx.message("ERROR getting jobs, possibly FFASTRANS API is offline.  ");

            }
        });
    }
    /* /NO PROXY MODE */
    function build_new_api_url(what) {
        if (JSON.parse(m_serverconfig['STATIC_USE_PROXY_URL'])) {
            return "/new_proxy" + what;
        } else {
            var _url = "http://" + m_serverconfig['STATIC_API_HOST'] + ":" + m_serverconfig['STATIC_API_NEW_PORT'] + what;
            return _url;
        }
    }

    function sortGrid(whichGrid, src_element_id, force_order) {
        
        src_element = document.getElementById(src_element_id);
        src_element_sorticon = document.getElementById(src_element_id + "-sorticon");
        //remove sort icons from all
        $('i[name="'+whichGrid+"-sorticon"+'"]').removeClass("fas fa-sort-up");
        $('i[name="'+whichGrid+"-sorticon"+'"]').removeClass("fas fa-sort-down");
        
        if (!src_element) {
            console.error("Error in sorting, finding element with id: " + src_element, src_element_id)
            return;
        }
        var whichColumn = src_element.getAttribute("name");
        var tree = $('#treetable_active').fancytree('getTree');
        if (whichGrid != "treetable_active") {
            tree = $('#treetable_history').fancytree('getTree');
        }

        if (!force_order) {
            //manual interaction, reverse current sort order
            if (src_element.dataset["sort_dir"] == "asc") {
                src_element.dataset["sort_dir"] = "des";
                $('i[id="'+src_element_id+"-sorticon"+'"]').addClass("fas fa-sort-down");
            } else {
                src_element.dataset["sort_dir"] = "asc";
                $('i[id="'+src_element_id+"-sorticon"+'"]').addClass("fas fa-sort-up");
            }
        } else {
            //force_order is only set when the order is automatically restored at page load, no need to reverse the sorting dir
            src_element.dataset["sort_dir"] = force_order
            if (force_order == "asc"){
                src_element.dataset["sort_dir"] = "asc";
                $('i[id="'+src_element_id+"-sorticon"+'"]').addClass("fas fa-sort-up");
            }else{
                src_element.dataset["sort_dir"] = "des";
                $('i[id="'+src_element_id+"-sorticon"+'"]').addClass("fas fa-sort-down");
            }
        }
        //remember the sorting
        m_lastsortelementid[whichGrid] = src_element_id;
        m_lastsortdir[whichGrid] = src_element.dataset["sort_dir"];
        
        //apply the sorting
        tree.getRootNode().sortChildren(function(a, b) {
            if (src_element.dataset["sort_dir"] == "asc") {
                return (a.data[whichColumn] + "").localeCompare(b.data[whichColumn])
            } else {
                return (b.data[whichColumn] + "").localeCompare(a.data[whichColumn])
            }
        }, true);
        
        //console.log("storing localstorage",JSON.stringify(m_lastsortelementid))
        localStorage.setItem("m_lastsortelementid", JSON.stringify(m_lastsortelementid));
        localStorage.setItem("m_lastsortdir", JSON.stringify(m_lastsortdir));
    }

        
    function clearSelection() {
    //used for clearing all unwanted browser text selections
        if(document.selection && document.selection.empty) {
            document.selection.empty();
        } else if(window.getSelection) {
            var sel = window.getSelection();
            sel.removeAllRanges();
        }
    }
    
        
    function parse_query_string(query) {
      var vars = query.split("&");
      var query_string = {};
      for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split("=");
        var key = decodeURIComponent(pair[0]);
        var value = decodeURIComponent(pair[1]);
        // If first entry with this name
        if (typeof query_string[key] === "undefined") {
          query_string[key] = decodeURIComponent(value);
          // If second entry with this name
        } else if (typeof query_string[key] === "string") {
          var arr = [query_string[key], decodeURIComponent(value)];
          query_string[key] = arr;
          // If third or later entry with this name
        } else {
          query_string[key].push(decodeURIComponent(value));
        }
      }
      return query_string;
    }
    
    function wokrflow_tree_control(what){
        var tree = $("#workflowtree").fancytree('getTree');
        if (what.id == "wf_filter_clear"){
            tree.selectAll(false);
        }
        if (what.id == "wf_filter_unexpand"){
            
        }
        if (what.id == "wf_filter_clear"){
            
        }
    }
</script>

<body onload="loadserverconfig()">

    <div style="display:none">
        <!-- global hiding div prevents showing raw tables before dhtmlx layout attaches the template divs -->
        <!-- THIS DIV CONTAINS THE FINISHED JOBGRID FANCYTREE TEMPLATE -->
        <div id="active_div" style="" class="gridbox_dhx_skyblue gridbox">
            <table id="treetable_active" class="obj">
                <colgroup id="colgroup_active" >
                    <col width="5%"></col>
                    <col width="10%"></col>
                    <col width="5%"></col>
                    <col width="10%"></col>
                    <col width="10%"></col>
                    <col width="10%"></col>
                    <col width="10%"></col>
                </colgroup>
                <thead class="dhtmlxMenu_dhx_skyblue_Middle sticky" style="border:none">
                    <tr id="tr_treetable_active">
                        <th id="active-state" name="state" onclick="sortGrid('treetable_active',this.id)" data-sort_dir="" >        <i id="active-state-sorticon" name="treetable_active-sorticon" ></i>State</th>
                        <th id="active-workflow" name="workflow" onclick="sortGrid('treetable_active',this.id)" data-sort_dir="">   <i id="active-workflow-sorticon" name="treetable_active-sorticon" ></i>Workflow</th>
                        <th id="active-job_start" name="job_start" onclick="sortGrid('treetable_active',this.id)" data-sort_dir=""> <i id="active-job_start-sorticon" name="treetable_active-sorticon" ></i>Start</th>
                        <th id="active-file" name="file" onclick="sortGrid('treetable_active',this.id)" data-sort_dir="">           <i id="active-file-sorticon" name="treetable_active-sorticon" ></i>Source</th>
                        <th id="active-proc" name="proc" onclick="sortGrid('treetable_active',this.id)" data-sort_dir="">           <i id="active-proc-sorticon" name="treetable_active-sorticon" ></i>Processor@Host</th>
                        <th id="active-status" name="status" onclick="sortGrid('treetable_active',this.id)" data-sort_dir="">       <i id="active-status-sorticon" name="treetable_active-sorticon" ></i>Status</th>
                        <th id="active-progress" name="progress" onclick="sortGrid('treetable_active',this.id)" data-sort_dir="">   <i id="active-progress-sorticon" name="treetable_active-sorticon" ></i>Progress</th>
                    </tr>
                </thead>
            </table>
        </div>



        <!-- THIS DIV CONTAINS THE FINISHED JOBGRID FANCYTREE TEMPLATE -->
        <div id="history_div" style="" class="gridbox_dhx_skyblue gridbox">
            <table id="treetable_history" class="obj">
                <colgroup id="colgroup_history">
                    <col width="5%"></col>
                    <col width="10%"></col>
                    <col width="10%"></col>
                    <col width="10%"></col>
                    <col width="10%"></col>
                    <col width="30%"></col>
                    <col width="30%"></col>
                </colgroup>
                <thead class="sticky dhtmlxMenu_dhx_skyblue_Middle" style="border:none">
                    <tr id="tr_treetable_history">
                        <th id="history-state" name="state" onclick="sortGrid('treetable_history',this.id)" data-sort_dir="">           <i id="history-state-sorticon" name="treetable_history-sorticon" class=""></i> <input placeholder="State" style="width:90%;height:18px;margin-left:5px" type="search" name="search"  incremental autocomplete="off"></th>
                        <th id="history-wf_name" name="wf_name" onclick="sortGrid('treetable_history',this.id)" data-sort_dir="">       <i id="history-wf_name-sorticon" name="treetable_history-sorticon"></i>        <input placeholder="Workflow" style="width:90%;height:18px;margin-left:5px" type="search" name="search" incremental autocomplete="off"></th>
                        <th id="history-job_start" name="job_start" onclick="sortGrid('treetable_history',this.id)" data-sort_dir="">   <i id="history-job_start-sorticon" name="treetable_history-sorticon"/></i>      <input placeholder="Start" style="width:90%;height:18px;margin-left:5px" type="search" name="search" incremental autocomplete="off"></th>
                        <th id="history-duration" name="duration" onclick="sortGrid('treetable_history',this.id)" data-sort_dir="">     <i id="history-duration-sorticon" name="treetable_history-sorticon"></i>        <input placeholder="Duration" style="width:90%;height:18px;margin-left:5px" type="search" name="search" incremental autocomplete="off"></th>
                        <th id="history-job_end" name="job_end" onclick="sortGrid('treetable_history',this.id)" data-sort_dir="">       <i id="history-job_end-sorticon" name="treetable_history-sorticon"></i>        <input placeholder="End" style="width:90%;height:18px;margin-left:5px" type="search" name="search" incremental autocomplete="off"></th>
                        <th id="history-file" name="file" onclick="sortGrid('treetable_history',this.id)" data-sort_dir="">             <i id="history-file-sorticon" name="treetable_history-sorticon"></i>           <input placeholder="File" style="width:90%;height:18px;margin-left:5px" type="search" name="search" incremental autocomplete="off"></th>
                        <th id="history-outcome" name="outcome" onclick="sortGrid('treetable_history',this.id)" data-sort_dir="">       <i id="history-outcome-sorticon" name="treetable_history-sorticon"></i>        <input placeholder="Outcome" style="width:90%;height:18px;margin-left:5px" type="search" name="search" incremental autocomplete="off"></th>
                    </tr>
                </thead>
            </table>
        </div>
        
         <!-- WORKFLOW FILTER TEMPLATE -->
        <div id="workflow_filter_menu" class="workflow_filter_background" style="">
            <div class='dhtmlxMenu_dhx_skyblue_Middle workflow_filter_menu_item' style='width:100% ;height:40px;white-space:nowrap'>
                <!-- <button title="Expand all Folders"    name="expand_wf"    class="workflow_filter_menu_item" onclick="wokrflow_tree_control(this)" id="wf_filter_expand" style='margin-left:5px;font-size: 7px;'> <i class="fas fa-plus"></i></button> -->
                <!-- <button title="Collapse all Folders"  name="collapse_wf"  class="workflow_filter_menu_item" onclick="wokrflow_tree_control(this)" id="wf_filter_unexpand" style='font-size: 7px;'> <i class="fas fa-minus"></i></button> -->
                <button title="Delete Selection (Show all Workflows)" name="delsel"       class="workflow_filter_menu_item" style="width:30px;height:30px;margin-top:5px;margin-left:5px" onclick="wokrflow_tree_control(this)" id="wf_filter_clear" style='font-size: 7px;'> <i class="fas fa-ban"></i></button>
                <input name='wf_filter' class="workflow_filter_menu_item" style='margin-top:5px;height:20px;margin-left:10px;margin-bottom:5px' id='wf_filter' autocomplete='off'></input> <i class="fas fa-search"></i>
            </div>
            <div id='workflowtree' style='margin-left:10px;margin-top:10px;margin-bottom:40px'/>
        </div>
        
        
    </div><!-- global hiding div -->
    
    <!-- html code to be loaded by javascript into dhtmlx cells. This is not directly shown on the page but loaded as a template on demand -->
    <div style="display:none" id="dhtmlx attachObject Templates">

    </div>
</body>
