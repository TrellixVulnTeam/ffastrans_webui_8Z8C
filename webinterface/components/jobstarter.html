<html>
<head>

<script src="../dependencies/dhtmlx/dhtmlx.js"></script>
<link rel="stylesheet" href="../dependencies/dhtmlx/dhtmlx.css" type="text/css"/> 
<script src="../dependencies/dhtmlx/vault/vault.js"></script>
<link rel="stylesheet" href="../dependencies/dhtmlx/vault/vault.css" type="text/css"/> 
<script src="../dependencies/jquery/jquery.js"></script>
<script src="../configuration/staticStrings.js"></script>
<link rel="stylesheet" href="../dependencies/fontawesome/css/all.css"/>
<style>
    /* it's important to set width/height to 100% for full-screen init */
    html, body {
        width: 100%;
        height: 100%;
        margin: 0px;
        overflow: hidden;
    }

</style>

<script>

/* GLOBALS */
var m_mainLayout,m_mainForm,m_subForm,m_selectedFileGrid,m_workflowArray,m_fileBrowserGrid,m_fileBrowseGridMenu,m_workflowTabBar;
var m_realUploadpath = "";

/* build basic page layout and init periodic job loading*/
function init(){
    //load config data from server
    getRealUploadPath();
    getBrowseLocations();
    //main layout
    m_mainLayout = new dhtmlXLayoutObject({
        parent: document.body,  
        pattern: "2U"           
    });
    
    m_mainLayout.listAutoSizes();
    
    m_mainLayout.cells("a").setText("Uploads");
    //m_mainLayout.cells("a").setWidth();
    var m_mainTabBar = m_mainLayout.cells("a").attachTabbar({
        mode:               "top",
        align:              "left",
        close_button:       true,
        content_zone:       true,
        onload:             function(){},
        arrows_mode:        "auto" ,
        tabs: [ // tabs config
            {
                id:"browse",text:"Browse",width:null,index:0,active:true,enabled: true,close:false
            },
            {
                id:"upload",text:"Upload",width:null,index:1,active:false,enabled: true,close:false
            },
        ]
    });

	m_fileBrowserGrid = m_mainTabBar.tabs("browse").attachGrid();
    m_fileBrowserGrid.setImagePath("dependencies/dhtmlx/imgs");                 
    m_fileBrowserGrid.setHeader("Name,Path,is_folder,size");//the headers of columns  
    m_fileBrowserGrid.attachHeader("#text_filter,#text_filter");  
    m_fileBrowserGrid.setInitWidthsP("*,0,0,20");          //the widths of columns  
    m_fileBrowserGrid.setColAlign("left,left,left,left");       //the alignment of columns   
    m_fileBrowserGrid.setColTypes("ro,ro,ro,ro");                //the types of columns  
    m_fileBrowserGrid.setColSorting("str,str,str,int");          //the sorting types    
    m_fileBrowserGrid.init();      //finishes initialization and renders the grid on the page 
	
	m_fileBrowseGridMenu = m_mainTabBar.tabs("browse").attachMenu({                                               
		items:[
            {id:"location", text:"Locations"},
			{id:"select", text:"Select File"},
		]
	});
	
    
    m_mainLayout.cells("b").setText("Job Configuration");
    var headerMenu = m_mainLayout.cells("b").attachMenu({                                               
            items:[
                 {id:"add", text:"<i class='fa fa-folder-plus'></i>Add"},
                 {id:"remove", text:"<i class='fa fa-folder-minus'></i>Delete"},
                 
            ]
        });
    
	m_mainTabBar.tabs("upload").attachHTMLString("<div id='vault')/>");
    var vault = new dhx.Vault('vault', {
        uploader:{ 
            target:"/backend/upload" 
       }
    });

    //workflow forms
    var jobLayout = m_mainLayout.cells("b").attachLayout({
        parent: document.body,  
        pattern: "2E"           
    });
    jobLayout.cells("a").hideHeader();
    jobLayout.cells("a").setText("Selected Files");
    jobLayout.cells("b").hideHeader();
    jobLayout.cells("a").setHeight($(document).height()/3.5);
    m_workflowTabBar = jobLayout.cells("b").attachTabbar({
        mode:  "top", align: "left", close_button: true,content_zone:true,onload:function(){},arrows_mode:"auto" ,
        tabs: [ // workflow and variable tabs config
            {
                id: "workflowtab", text:"Workflows",width:null,index:0,active:true, enabled: true, close:false
            },
             
            {
                id:"variabletab",text:"Variables",width:null,index:1,active:false,enabled:false,close:false 
            },
        ]
    });
    
    //add workflow selection components
    
    m_workflowSelectorGrid = m_workflowTabBar.tabs("workflowtab").attachGrid();
    m_workflowSelectorGrid.setImagePath("dependencies/dhtmlx/imgs");                 
    m_workflowSelectorGrid.setHeader("Name,Group");
    m_workflowSelectorGrid.setInitWidthsP("50,50");
    m_workflowSelectorGrid.setColAlign("left,left");
    m_workflowSelectorGrid.setColTypes("ro,ro");
    m_workflowSelectorGrid.setColSorting("str,str"); 
    m_workflowSelectorGrid.attachHeader("#text_filter,#text_filter");    
    m_workflowSelectorGrid.init();
    
    
    m_workflowTabBar.tabs("variabletab").attachHTMLString('<div id="mainform" style="width:100%;height:65px;"></div><div id="subform" style="width:100%;height:400px;"></div>');
    
    
    //mainform is for workflow and processor selection, subform for variables
    m_mainForm  = new dhtmlXForm("mainform");
    m_mainForm.addItem(null, {type: "label", label: "Start Processor"},0);
    m_subForm  = new dhtmlXForm("subform");

    m_selectedFileGrid = jobLayout.cells("a").attachGrid();
    m_selectedFileGrid.setImagePath("dependencies/dhtmlx/imgs");                 
    m_selectedFileGrid.setHeader("Source,Path");
    m_selectedFileGrid.setInitWidthsP("20,80");
    m_selectedFileGrid.setColAlign("left,left");
    m_selectedFileGrid.setColTypes("ed,ed");
    m_selectedFileGrid.setColSorting("str,str");   
  
    m_selectedFileGrid.init();
    
    //EVENTS
    m_workflowSelectorGrid.attachEvent("onRowSelect", function(id,ind){
		//workflow was selected
		on_gridWorkflowSelected(id);
	});
    


    //workflow and start proc selected event
    m_mainForm.attachEvent("onChange", function (name, value, state){
            if (name == 'start_proc'){
                //on_processorSelected(value);
            }
    });
    
    //file uploaded event
    vault.events.on("UploadComplete", function(files){
        for (i=0;i<files.length;i++){
            var newId = (new Date()).valueOf();
            m_selectedFileGrid.addRow(newId,["Upload",files[i].name]);
        }
    });
    
    //file add remove event
    headerMenu.attachEvent("onClick", function(id, zoneId, cas){
            if (id == "add") {
                var box = dhtmlx.modalbox({
                    title:"New File",
                    text: "Enter a Full Path (e.g. UNC) as seen by FFAStrans Server...<br/><input class='inform' type='text'>",
                    buttons:["OK",  "Cancel"],
                    callback: function(result){
                        if (result == 0){
                            var inputs = box.getElementsByTagName("input");
                            var newId = (new Date()).valueOf();
                            m_selectedFileGrid.addRow(newId,["Manual",inputs[0].value]);
                        }
                    }
                });
            }
            if (id == "remove") {
                if (!m_selectedFileGrid.getSelectedRowId()){
                    dhtmlx.alert("Please select a File to delete");
                }
                m_selectedFileGrid.deleteSelectedRows();
            }
            if (id=="submit"){
                startJobs();
            }
         
    });
    
	//file browser events
	m_fileBrowserGrid.attachEvent("onRowSelect", function(id,ind){
		//change folder 
		if (m_fileBrowserGrid.cells(id,2).getValue() == "true"){
			getFileList(m_fileBrowserGrid, m_fileBrowserGrid.cells(id,1).getValue())
		}
	});
	
	m_fileBrowseGridMenu.attachEvent("onClick", function(id, zoneId, cas){
		if (id == "select") {
			if (!m_fileBrowserGrid.getSelectedRowId()){
				dhtmlx.message("Please select a File in the file browser");
				return;
			}
			selectFileToProcess();
            return;
		}
        //in any other case, a folder in "select" menu was chosen
        getFileList(m_fileBrowserGrid,id)
	})
    
//MAIN STARTING POINT
    //load workflow list from API
    m_mainLayout.cells("b").progressOn();
    getWorkflows();
}

function getReadableFileSizeString(fileSizeInBytes) {
//helper, translates number of file size bytes into human readable value
	if (fileSizeInBytes == 0){
		return "0 kB";
	}
    var i = -1;
    var byteUnits = [' kB', ' MB', ' GB', ' TB', 'PB', 'EB', 'ZB', 'YB'];
    do {
        fileSizeInBytes = fileSizeInBytes / 1024;
        i++;
    } while (fileSizeInBytes > 1024);

    return Math.max(fileSizeInBytes, 0.1).toFixed(1) + byteUnits[i];
}

function selectFileToProcess(){
    //transfer selected file to processing grid
    m_selectedFileGrid.addRow(Math.random(),["Browse",m_fileBrowserGrid.cells(m_fileBrowserGrid.getSelectedRowId(),1).getValue()]);
}

function getFileList(dhtmlxGrid,path){
//browse files on server
	    $.ajax({
        url: "/filebrowser?name=" + path +"&"+Math.random(),
        type: "GET",
        success: function (response,textStatus, xhr) {
            localStorage.setItem("lastVisitedBrowseLocation", path);
			dhtmlxGrid.clearAll();
			dhtmlxGrid.parse(response,"json");
			dhtmlxGrid.forEachRow(function(id){
			//convert filesize to human readable
				dhtmlxGrid.cells(id,3).setValue( getReadableFileSizeString(dhtmlxGrid.cells(id,3).getValue()));
				if (dhtmlxGrid.cells(id,2).getValue() =="true"){
                    //folders get a folder icon attached
					dhtmlxGrid.cells(id,0).setValue( '<i class="fas fa-folder"></i> ' + (dhtmlxGrid.cells(id,0).getValue()) );
				}else{
                    dhtmlxGrid.getRowById(id).addEventListener('dblclick', function(){ 
                        selectFileToProcess();
                    });
                }
			});
        },
        error: function (xhr, status) {
            dhtmlx.message("ERROR, unexpected error from filebrowser. " + path + " " + xhr.responseText);
        }
    });
}

function getRealUploadPath(){
//request data fom server and set global var
    $.ajax({
        url:  "/getfulluploadpath" + "?"+Math.random(),
        type: "GET",
        crossDomain: true,
        success: function (response) {
           m_realUploadpath = response;
        },
        error: function (xhr, status) {
            dhtmlx.message("ERROR, could not GET getfulluploadpath, contact developer");
        }
    });
}

function getBrowseLocations(){
//request data fom server and set global var
    $.ajax({
        url:  "/getbrowselocations" +"?"+Math.random(),
        type: "GET",
        dataType: "json",
        crossDomain: true,
        success: function (response) {
           m_browseLocations = response;
           for (i=0;i<m_browseLocations.values.length;i++){
                m_fileBrowseGridMenu.addNewChild("location", i, m_browseLocations.values[i], m_browseLocations.display_names[i], false,"","");
           }
           if (localStorage.getItem("lastVisitedBrowseLocation")){
                getFileList(m_fileBrowserGrid,localStorage.getItem("lastVisitedBrowseLocation")); //restore last visit location
           }else{
                getFileList(m_fileBrowserGrid, m_browseLocations.values[0]);    //load first available location
           }
        },
        error: function (xhr, status) {
            dhtmlx.message("ERROR, could not GET getbrowselocations, contact developer " + xhr);
        }
    });
}

function on_processorSelected(selectedWorkflow){
    //called from onChange function of Form
    //populates variables and start  button

    //due to unknown reason (maybe bug), we have to ask STATIC_GET_WORKFLOWS_URL for workflow variables. The details we already have don't contain the user_vars
    /*for (i=0;i<selectedWorkflow.user_variables.length;i++){
        m_mainForm.addItem(null, {type: "text", name: "user_var"+i, label: "Start Processor:"}, "1"+i)
    }*/
    
    
    var selectedWorkflow = m_mainForm.getUserData("start_proc", "workflow_object");
        
    //workaround load user_variables from workflow api call

    $.ajax({
        url:  buildUrl(STATIC_GET_WORKFLOWS_URL + "/" + selectedWorkflow.wf_id ),
        type: "GET",
        crossDomain: true,
        dataType: "json",
        context: this,
        success: function (response) {
            //rebuild subform
            if (m_subForm){ 
                m_subForm.unload();//clear existing form items
                m_subForm = null;
            }
            m_subForm  = new dhtmlXForm("subform");
            m_subForm.addItem(null, {type: "label", label: "User Variables"},1);
            
            m_subForm.attachEvent("onButtonClick", function(name){
                if(name == "submit"){
                    startJobs();
                }
            });             
             
            if (response['workflows'].length == 0){
                alert("ERROR, contact developer. Did not get Information for workflow " + selectedWorkflow.wf_id);
            }else{
                //ok, we have the workflow info, populate user variables and start btn
                if (!("variables" in response.workflows[0])){
                    m_subForm.addItem(1, {type: "label", label:"This Workflow does not provide any userinput" ,offsetLeft:20 }, 2);
					m_subForm.addItem(null, {type: "button", name:"submit",value: "Start Job"},10000);
                    m_workflowTabBar.goToNextTab();
                    return;
                }
                for (i=0;i<response.workflows[0].variables.length;i++){
                    //add uservariables inputs
                    var current_var = response.workflows[0].variables[i];
                    var desc = current_var.description  == "" ? current_var.name : current_var.description;
                    if (current_var.name.indexOf("webui") != -1){
                        //detected a variable that interacts with webui (should have JSON default value)
                        try{
                            var var_object = JSON.parse(current_var.description);
                            parseWebUiTypeUserVariable(m_subForm,var_object,current_var.name);//special support for key value arrays!
                        }catch(e){
                            dhtmlx.alert("Workflow config error, user variables with \"webui\" in their names must have a valid JSON description. Actual description was: <br/>\""+current_var.description+"\"");
                        }
                    }else{
                        //standard ffastrans variables
                        var displayName = current_var.name;
                        displayName = displayName.replace("s_", "");//todo: add support for native ffastrans variable types
                        m_subForm.addItem(current_var.name, {type: "input", name: current_var.name, label: current_var.name, tooltip:desc, offsetLeft:20 }, "100"+i);
                        
                    }
                }
                //finally add start job button
                m_subForm.addItem(null, {type: "button", name:"submit",value: "Start Job"},10000);
                m_subForm
                m_workflowTabBar.goToNextTab();
            }
        },
        error: function (xhr, status) {
            dhtmlx.message("ERROR getting workflows, possibly FFASTRANS API is offline. ");
        }
    });
}

function parseWebUiTypeUserVariable(dhxForm,var_obj,var_name){
    var errormsg = "Workflow configuration error, Please edit the description of the variable "+var_name+"to contain a valid JSON key value array";
    if (var_obj.length == 0){
        dhtmlx.alert(errormsg)
    };
    try{
        var var_display_name = var_name;
        var_display_name = var_display_name.replace("s_webui_", "");//todo: add support for native ffastrans variable types
        var options=[];
        for (i=0;i<var_obj.length;i++){
            options.push({text:var_obj[i].key,value:var_obj[i].value});
        }
        var itemData = {type: "select",name: var_name, label: var_display_name, options: options,  offsetLeft:10};
        dhxForm.addItem(var_name, itemData, new Date().valueOf());
    }catch(e){
        dhtmlx.alert("Error Parsing webui variable \"" + var_name + "\" Message:" + errormsg);
    }

}


function on_gridWorkflowSelected(rowId){
    //called from select event of grid select
    //populates start processor drowdown
    
    var options = [];
    m_mainForm.removeItem("start_proc");
    var selected_wf = m_workflowSelectorGrid.getUserData(rowId,"workflow_object");
    
    //todo: parse processors and create form in layout cell B
    //variable.start_procs[]
    var proc_root = selected_wf.variable["start_procs"] || selected_wf.variable["start_proc"];
    if (!proc_root){
        dhtmlx.alert("Fatal error parsing workflow, start_proc was not found")
    }
    for (i=0;i<proc_root.length;i++){
        var proc = proc_root[i];
        var proc_name_default= proc.split(/ /)[0]; //this splits of the node id from proc_name, assumed a structure like op_populate 20151220-09......
        var proc_name = "First Processor";
        if (selected_wf[proc]["properties"]){
            proc_name = selected_wf[proc].properties.custom_node_name ||proc_name_default; 
        }
        
        options.push({text:proc_name,value:proc});
    }
    var itemData = {type: "select",name: "start_proc", label: "Start Processor:", options: options,  offsetLeft:10};   
    m_mainForm.addItem("start_proc", itemData, 2);
    m_mainForm.setUserData("start_proc", "workflow_object", selected_wf);       //store selected workflow along with start_proc
    //switch to variables tab
    on_processorSelected(selected_wf);                                           //auto select first processor    
    //switch to variables Tab
    
}


function parseWorkflows(wfArray){
//callback for getWorkflows
    m_mainLayout.cells("b").progressOff();

    //fill drowdowns
    var parents = [];
    var options = [];
    for (i=0;i<wfArray.length;i++){
        var row = m_workflowSelectorGrid.addRow(wfArray[i].general.wf_id,[wfArray[i].general.wf_name, wfArray[i].general.folder]);
        m_workflowSelectorGrid.setUserData(wfArray[i].general.wf_id,"workflow_object",wfArray[i]);
    }
}

function getWorkflows(){

    $.ajax({
        url:  buildUrl(STATIC_GET_WORKFLOW_DETAILS_URL),
        type: "GET",
        crossDomain: true,
        dataType: "json",
        success: function (response) {
            if (response['workflows/details'].length == 0){
                alert("Did not get any workflows from FFASTRANS API");
            }else{
                m_workflowArray = response['workflows/details'];
                parseWorkflows(m_workflowArray);
            }
        },
        error: function (xhr, status) {
            dhtmlx.message("ERROR getting workflows, possibly FFASTRANS API is offline. ");
        }
    });
}

function startJobs(){
//kick off one workflow per file in grid
    if (m_selectedFileGrid.getRowsNum() == 0){
        dhtmlx.alert("Cannot start job, please add a File to process");
        return;
    }
    m_selectedFileGrid.forEachRow(function(id){
        var source = m_selectedFileGrid.cells(id,0).getValue();
        var _filepath = (m_selectedFileGrid.cells(id,1).getValue());
        if (source == "Upload"){
            _filepath = m_realUploadpath + _filepath;
        }
        
         var postBody = {}; //the JSON STructure for start job api
         var selectedWorkflow = m_mainForm.getUserData("start_proc", "workflow_object");
         postBody.wf_id = selectedWorkflow.wf_id;
         var selectedStartProc = m_mainForm.getSelect("start_proc").selectedOptions[0].value;
         postBody.start_proc = selectedStartProc;
         postBody.inputfile = _filepath;
         postBody.variables = [];
         m_subForm.forEachItem(function(name){
            if (m_subForm.getItemValue(name)){
                postBody.variables.push({"name":name,"content":m_subForm.getItemValue(name)});
            }
        });
         console.log(postBody);
         $.ajax({
            url:  buildUrl(STATIC_START_JOB_URL),
            type: "POST",
            crossDomain: true,
            //dataType: "json",
            data: JSON.stringify(postBody),
            success: function (response) {
                dhtmlx.message(_filepath + " was submitted")
            },
            error: function (xhr, status) {
                dhtmlx.alert("Error submitting workflow: " + xhr.responseText);
            }
        });
    
    });

}

function buildUrl(what){
    var _url = "http://" + STATIC_API_HOST + ":" + STATIC_API_PORT + what;
    return  _url;
}
</script>

</head>
<body onload="init()">

</body>