<html>
<head>
<script src="/socket.io/socket.io.js"></script>
 <script src="../dependencies/dhtmlx/dhtmlx.js"></script> 
 <link rel="stylesheet" href="../dependencies/dhtmlx/dhtmlx.css" type="text/css"> 


<!-- <script src="../dependencies/dhtmlx/vault/vault.js"></script> -->
<!-- <link rel="stylesheet" href="../dependencies/dhtmlx/vault/vault.css" type="text/css"> -->
<script src="../dependencies/jquery/jquery.js"></script>
<link rel="icon" href="favicon.ico?v=1.1">
<link rel="stylesheet" href="../dependencies/fontawesome/css/all.css" />


<!-- <link href="../dependencies/fancytree/modules/jquery.resizableColumns.css" rel="stylesheet"> -->
<!-- <script src="../dependencies/fancytree/modules/jquery.resizableColumns.js"></script> -->

<script src="../dependencies/fancytree/modules/colResizable-1.6.min.js"></script>

<link href="../dependencies/fancytree/skin-custom-1/ui.fancytree.css" rel="stylesheet">

<script src="../dependencies/fancytree/modules/jquery.fancytree.ui-deps.js"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.js" type="text/javascript"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.dnd.js" type="text/javascript"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.filter.js" type="text/javascript"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.edit.js" type="text/javascript"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.gridnav.js" type="text/javascript"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.table.js" type="text/javascript"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.multi.js"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.fixed.js"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.contextmenu.js"></script>

<!-- jquery-contextmenu (https://github.com/swisnl/jQuery-contextMenu) -->
<link rel="stylesheet"
      href="../dependencies/fancytree/modules/jQuery-contextMenue/jquery.contextMenu.min.css" />
<script src="../dependencies/fancytree/modules/jQuery-contextMenue/jquery.contextMenu.min.js">
</script>

<style>
    /* it's important to set width/height to 100% for full-screen init */
    html, body {
        /* width: 100%; */
        height: 100%;
        margin: 0px;
        overflow: hidden;
        color: #333;
        font: 14px Helvetica, Arial, sans-serif;
        line-height: 18px;
    }

    .fas {
        opacity: 0.9;                /* Opacity (Transparency) */
        color: rgba(0, 0, 0, 0.9);   /* RGBA Color (Alternative Transparency) */
        
    }

    button {
        cursor: pointer;
    }

    .progressbar {
        border-radius: 5px;
        height: 15px;
        background-color: #4CAF50;
        margin: 0;
        padding: 0;
        text-align: center;
        vertical-align: middle;
        white-space: nowrap;
    }


    /*layout headers (big blue lines)*/
    .dhxlayout_base_material div.dhx_cell_layout div.dhx_cell_hdr {
        height: 25px;
        line-height: 23px;
        font-size: 12px;
    }

        /*collapse icon in layout header*/
        .dhxlayout_base_material div.dhx_cell_layout div.dhx_cell_hdr div.dhxlayout_arrow.dhxlayout_arrow_ha {
            background-position: -32px -5px;
            z-index: 1;
            margin-top: -3;
        }
    /*collapse icon in layout header*/
    div.dhx_cell_layout div.dhx_cell_hdr div.dhxlayout_arrow.dhxlayout_arrow_vb {
        margin-top: -8px;
        z-index: 1;
    }

    /*fancytree line break*/
    table.fancytree-ext-table tbody tr td {
        text-overflow: ellipsis;
        /*white-space: nowrap;*/
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
    }

    /* tree column resize issues*/
    table {
        border: 1px;
        table-layout: fixed;
        width: 100%;
        outline: none;
    }
    /* tree column resize issues*/
    th,
    td {
        border: 1px;
        overflow: hidden;
        font-weight: unset;
    }
    th{
        border-right: 1px solid grey;
    }
    /* text in tree title column */
    span.fancytree-title {
        padding: 0 0 0;
    }
    /*three dots on text overflow*/
    .celltext {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        user-select: text;
        margin-left: 6px;
    }

    .celltext_clicked {
        text-overflow: clip;
        white-space: normal;
        word-break: break-all;
        user-select: text;
    }
   
    /*context menu stuff*/
    td:hover {
        opacity:0.5;
    }
    .context-menu-active {
        opacity:0.5;
    }
</style>

<script>
    /* init SOCKET.IO */
    var socket = io();

    /* GLOBALS */
    var mainLayout, runningJobGrid, finishedJobGrid, m_serverconfig, m_userpermissions, m_lastsortelementid, m_lastsortdir;
    var m_rowColorError = "#f28d80"
    var m_rowColorCancelled = "#ffcc80"

    /*load config from server*/
    function loadserverconfig() {
        $.ajax({
            url: ("/getuserpermissions" + "?" + Math.random()),
            type: "GET",
            success: function(response) {

                m_userpermissions = JSON.parse(response);
                //load serverconfig and initialize page
                $.ajax({
                    url: ("/getserverconfig" + "?" + Math.random()),
                    type: "GET",
                    success: function(response) {
                        m_serverconfig = JSON.parse(response);
                        init();
                    },
                    error: function(xhr, status) {
                        dhtmlx.message("Fatal error, could not load serverconfig. ");
                        document.body.innerHTML = "Fatal error, could not load serverconfig. " + xhr.responseText;
                    }
                });
            },
            error: function(xhr, status) {
                dhtmlx.message("Fatal error, could not load serverconfig. ");
                document.body.innerHTML = "Fatal error, could not load serverconfig. " + xhr.responseText;
            }

        });

    }

    /*get active jobs immediately - should cause server to push jobs to us via socket.io*/
    function forcejobloading() {

        $.ajax({
            url: ("/getactivejobsajax_treegrid"),
            type: "GET",
            success: function(response) {},
            error: function(xhr, status) {}
        });
    }
    
    /* render menu buttons based on userpermissions*/
    function addMenuButtons(){
        
        //menu buttons html
        var a_details = '<button class="btn" name="a_details" onclick="click_a_header(this.name)"><i style = "margin-right:3px" class= "fas fa-info-circle fa-sm" ></i>Job Details</button> ';
        var a_abort = '<button class="btn" name="a_abort" onclick="click_a_header(this.name)"><i style = "margin-right:3px;" class= "fas fa-stop fa-sm" ></i>Abort</button>';
        var a_pause = '<button class="btn" name="a_pause" onclick="click_a_header(this.name)"><i style = "margin-right:3px" class= "fas fa-pause fa-sm" ></i>Pause</button>';
        var a_resume = '<button class="btn" name="a_resume" onclick="click_a_header(this.name)"><i style = "margin-right:3px" class= "fas fa-play fa-sm" ></i>Resume</button>';
        var a_priority = '<button class="btn" name="a_priority" onclick="click_a_header(this.name)"><i style = "margin-right:3px" class= "fas fa-edit fa-sm" ></i>Priority</button>';
        var arr_all_in_a = [a_details,a_abort,a_pause,a_resume,a_priority];
        
        var b_details = '<button class="btn" name="b_details" onclick="click_b_header(this.name)"><i style = "margin-right:3px" class= "fas fa-info-circle fa-sm"></i>Job Details</button>';
        var b_resubmit = '<button class="btn" name="b_resubmit" onclick="click_b_header(this.name)"><i style = "margin-right:3px" class= "fas fa-retweet fa-sm" ></i>Resubmit</button>';
        var b_delall = '<button class="btn" name="b_delall" onclick="click_b_header(this.name)"><i style = "margin-right:3px" class= "fas fa-trash-alt fa-sm" ></i>Delete All</button>';
        var b_delsel = '<button class="btn" name="b_delsel" onclick="click_b_header(this.name)"><i style = "margin-right:3px" class= "fas fa-trash-alt fa-sm" ></i>Delete Selected</button> ';
        var arr_all_in_b = [b_details,b_resubmit,b_delall,b_delsel];
        
        //check user permissions
        var _filter = _getObjectByValue(m_userpermissions,"FILTER_JOBSTATUS_BUTTONS");
        if (_filter.length > 0){
            
            var regex = new RegExp( _filter[0]["value"]["filter"], 'gi' );
            console.log("Displaying filtered list of buttons, regex: ", regex);
            
            //add filtered btns to Running jobgrid
            for (_id=0;_id<arr_all_in_a.length;_id++){
                if (arr_all_in_a[_id].match(regex)){
                    _appendtext('a',arr_all_in_a[_id])
                }
            }
            //no filter, add filtered btns to History jobgrid
            for (_id=0;_id<arr_all_in_b.length;_id++){
                if (arr_all_in_b[_id].match(regex)){
                    _appendtext('b',arr_all_in_b[_id])
                }
            }
        }else{
            //just render all btns
            console.log("Displaying unfiltered list of menu buttons" )
            _appendtext('a',arr_all_in_a.join("") );
            _appendtext('b', b_details + b_resubmit + b_delall + b_delsel);
        }
        function _appendtext (cellid, to_append){//helper
            mainLayout.cells(cellid).setText(mainLayout.cells(cellid).getText() + to_append);
        }

    }

    function _getObjectByValue(object, value) {//helper
        var to_return = [];
        for (var _idx in object){
           var _v =  object[_idx]["key"];
           if (_v == value){
            to_return.push(object[_idx]);
           }
        }
        return to_return;
    }
        
    /* build basic page layout and init periodic job loading*/
    function init() {

        //kick off DB maintenance verytime a client opens the UI - fire and forget
        $.get("/deleteoldrecords");

        //check if html5 features supported
        if (typeof(Storage) !== "undefined") {} else {
            dhtmlx.message("ERROR, no html5 store support, cannot save view state")
        }

        mainLayout = new dhtmlXLayoutObject({
            // mainLayout = headerLayout.cells("b").attachLayout({
            parent: document.body,
            pattern: "2E"
        });


        mainLayout.cells("b").setWidth($(document).width() / 3);
        //mainLayout.cells("c").setText("Finished");
        mainLayout.cells("a").setHeight($(document).height() / 3.5);
        restoreLayoutSizes(mainLayout, "mainLayout");

        //attach grids
        mainLayout.cells("b").attachObject("history_div");
        mainLayout.cells("b").showInnerScroll();
        mainLayout.cells("a").attachObject("active_div");
        mainLayout.cells("a").showInnerScroll();
        
        //menu text and buttons
        mainLayout.cells("a").setText('<span style="margin-right:15px;font-size:13px" >Running</span>');
        mainLayout.cells("b").setText('<span style="margin-right:15px;font-size:13px" >Finished</span>');
        addMenuButtons();
        
        mainLayout.attachEvent("onPanelResizeFinish", function() {
            saveLayoutSizes(mainLayout, "mainLayout");
        });

        //    mainLayout.cells("a").progressOn();

        socket.on('newhistoryjob', function(msg) {

            if (applyWorkflowFilter(msg) == false) {
                return;
            }
            //server informs us about new history jobs in db, if there are new, we fetch them
            var rootNode = $("#treetable_history").fancytree("getRootNode");

            var existing_node = rootNode.tree.getNodeByKey(msg.key)
            if (existing_node) {
                existing_node.remove();
            }

            firstnode = rootNode.findFirst("")
            if (firstnode) {
                if (firstnode.extraClasses == "odd_dhx_skyblue") {
                    msg.extraClasses = "ev_dhx_skyblue";
                } else {
                    msg.extraClasses = "odd_dhx_skyblue";
                }
            }
            //add new node

            var childNode = rootNode.addChildren(msg, $("#treetable_history").fancytree("getRootNode").getFirstChild());

        });

        socket.on('pendingjobs', function(msg) {
            if (JSON.parse(msg)) {
                var q_obj = (JSON.parse(msg));
                addActiveJobsToGrid(runningJobGrid, q_obj, "Pending");
            }
            mainLayout.cells("a").progressOff();
        });
		
        socket.on('queuedjobs', function(msg) {
            if (JSON.parse(msg)) {
                var q_obj = (JSON.parse(msg))
                addActiveJobsToGrid(runningJobGrid, q_obj, "Queued");
            }
            mainLayout.cells("a").progressOff();
        });
        socket.on('activejobs', function(msg) {
            addActiveJobsToGrid(runningJobGrid, JSON.parse(msg), "Active");
            mainLayout.cells("a").progressOff();
        });
        socket.on('error', function(msg) {
            dhtmlx.message(msg);
        });
        socket.on('msg', function(msg) {
            dhtmlx.message(msg);
        });

        //deprecated!!!
        if (!JSON.parse(m_serverconfig['STATIC_USE_PROXY_URL'])) {
            alert("running in pull mode, this should not happen")
            window.setInterval(function() {
                getQueuedJobs(runningJobGrid)
            }, parseInt(3000));
            window.setInterval(function() {
                getActiveJobs(runningJobGrid)
            }, parseInt(3000));
            window.setInterval(function() {
                getFinishedJobs(finishedJobGrid)
            }, parseInt(3000));
            getQueuedJobs(runningJobGrid);
            getActiveJobs(runningJobGrid);
            getFinishedJobs(finishedJobGrid);
        }

        //restore last sort order for active jobs
        m_lastsortelementid = localStorage.getItem("m_lastsortelementid");
        m_lastsortdir = localStorage.getItem("m_lastsortdir");
        if (!m_lastsortelementid || !m_lastsortdir) {
            m_lastsortelementid = "active-state";
            m_lastsortdir = "asc";
            console.log("Applying default sorting for active grid")
        } else {
            console.log("Applying stored sorting for active grid", m_lastsortelementid, m_lastsortdir)
        }

        buildHistoryGrid();
        buildActiveGrid();
        forcejobloading();
    }

    function click_a_header(id) {
        clearSelection();
        var tree = $('#treetable_active').fancytree('getTree');
        var selected = tree.getSelectedNodes();
        if (selected.length == 0) {
            dhtmlx.alert("Please select row");
            return;
        }

        if (id == "a_details") {
			if (selected[0].data["state"] == "Queued"){
				dhtmlx.message("Sorry, no details to show for queued jobs available");
				return;
			}
            var jobid = (selected[0].data["job_id"]); //active_jobs dont have a sort_family_name
            var url = "logviewer.html?job_id=" + jobid;
            window.open(url, '_blank');
        }
        if (id == "a_abort") {
            jobCommand(selected, "abort");
        }
        if (id == "a_pause") {
            jobCommand(selected, "pause");
        }
        if (id == "a_resume") {
            jobCommand(selected, "resume");
        }
        if (id == "a_priority") {
          
            jobCommand(selected, "priority");
        }
    }

    function click_b_header(id) {

        var tree = $('#treetable_history').fancytree('getTree');
        var selected = tree.getSelectedNodes();
        if (id == "b_resubmit") {
            var tree = $('#treetable_history').fancytree('getTree');
            var selected = tree.getSelectedNodes();
            selected.forEach(function(node) {
                resubmit_job(node["data"]["guid"]);
            })
        }
        if (id == "b_details") {
            if (selected.length == 0) {
                dhtmlx.alert("Please select row to show details");
                return;
            }
            var jobid = (selected[0].data["job_id"]); //jobid contains splitid, sort_family_name is the id of mother job without splitd
            var url = "logviewer.html?job_id=" + jobid;
            window.open(url, '_blank');
        }
        if (id == "b_delsel") {
            //delete selected jobs
            if (selected.length == 0) {
                dhtmlx.alert("Please select rows to delete ");
                return;
            }
            var array_to_delete = [];
            for (i = 0; i < selected.length; i++) {}
            selected.forEach(function(node) {
                array_to_delete.push(node.data["guid"]);
                node.remove();
            });
            socket.emit("deletejob", JSON.stringify(array_to_delete)); //note, custom structure for socket.emit messages


        }
        if (id == "b_delall") {
            //delete all jobs
            dhtmlx.confirm({
                title: "Delete ALL Jobs",
                type: "confirm-error",
                text: "Really delete ALL Jobs?",
                callback: function(yesno) {
                    if (yesno) {
                        socket.emit("deletealljobs"); //note, custom structure for socket.emit messages

                        var rootNode = $("#treetable_history").fancytree("getRootNode");
                        rootNode.removeChildren();
                    }
                } //callback
            }); //confirm
        } //delall
    }

    function buildActiveGrid() {

        var sourceUrl = "/gethistoryjobsajax_treegrid?filtercol=job_end&direction=des&count=200";
        //var sourceUrl = "testdata.xml";
        $("#treetable_active").fancytree({
            extensions: ["contextMenu","table", "gridnav", "multi"],
            icon: false,
            checkbox: false,
            titlesTabbable: true, // Add all node titles to TAB chain
            table: {
                indentation: 15,
                nodeColumnIdx: 0,
            },
            select: function(event, data) {
                if (data.node.isSelected()) {
                    data.node.addClass("rowselected");
                } else {
                    data.node.removeClass("rowselected");
                }
            },
            gridnav: {
                autofocusInput: false,
                handleCursorKeys: true
            },
            multi: { //multiselct
                mode: "",
            },
            init: function(event, data) {
                //ENABLE RESIZE COLUMNS
                console.log("TREE INIT")
                $("#treetable_active").colResizable({
                    resizeMode: 'fit',
                    hoverCursor: "col-resize",
                    dragCursor: "col-resize",
                    postbackSafe: true,
                    useLocalStorage: true,
                    minWidth: 10,
                    liveDrag: true,
                });

            },
            modifyChild: function(event, data) {
                //reset all odd even row colors
                var rootNode = $("#treetable_active").fancytree("getRootNode");
                var oldnodes = rootNode.children;
                for (i = 0; i < oldnodes.length; i++) {
                    if (i % 2 == 0) {
                        oldnodes[i].toggleClass("ev_dhx_skyblue", true)
                        oldnodes[i].toggleClass("odd_dhx_skyblue", false)
                    } else {
                        oldnodes[i].toggleClass("odd_dhx_skyblue", true)
                        oldnodes[i].toggleClass("ev_dhx_skyblue", false)
                    }
                }
            },
            renderColumns: function(event, data) {
                var node = data.node;
                node.addClass("act_row"); //for context menu
                if (data.node.getIndex() % 2 == 0) {
                    node.removeClass("odd_dhx_skyblue"); //apply dthmlx style to node
                    node.addClass("ev_dhx_skyblue"); //apply dthmlx style to node
                } else {
                    node.removeClass("ev_dhx_skyblue"); //apply dthmlx style to node
                    node.addClass("odd_dhx_skyblue"); //apply dthmlx style to node
                }

                $tdList = $(node.tr).find(">td");

                $tdList.eq(1).html("<div class='celltext'>" + node.data.workflow + "</div>"); //.addClass("alignRight");
                $tdList.eq(2).html("<div class='celltext'>" + node.data.job_start + "</div>");
                $tdList.eq(3).html("<div class='celltext'>" + node.data.file + "</div>");
                $tdList.eq(4).html("<div class='celltext'>" + node.data.proc + "@" + node.data.host + "</div>");
                $tdList.eq(5).html("<div class='celltext'>" + node.data.status + "</div>");
                $tdList.eq(6).html('<div class="progressbar" style=" width:' + node.data.progress + '%">' + node.data.progress + '% ' + node.data.steps.replace(/ /g, "") + '</div>');

                data.tree.getRootNode().sortChildren(function(a, b) {
                    return (a.data.state.localeCompare(b.data.state))
                }, true);

            },
            postProcess: function(event, data) {
                // transform gethistoryjobsajax result into tree compatible
                // data is a treegrid specific object
                console.log("POSTPROC")
                data["result"] = data["response"]["data"] //setting data["result"] means override the originally loaded data
            },
            dblclick: function(event, data) {},
            select: function(event, data) {
                
                if (data.node.isSelected()) {
                    data.node.addClass("rowselected");
                } else {
                    data.node.removeClass("rowselected");
                }
            },
            contextMenu: {
            
                selector: "act_row",
                menu: getContextMenuHistoryGrid( 
                    {   
                        "details": {
                            "name": "Job Details"
                        },
                        "prio": {
                            "name": "Priority",
                            "items": {
                                "prio_0": { "name": "0 (Low)" },
                                "prio_1": { "name": "1" },
                                "prio_2": { "name": "2" },
                                "prio_3": { "name": "3" },
                                "prio_4": { "name": "4 (High)" }
                            }
                        },
                        '<i style = "margin-right:3px" class= "fas fa-pause fa-sm" ></i> pause': {
                            "name": "Pause"
                        },
                        "resume": {
                            "name": "Resume"
                        },                        
                        "abort": {
                            "name": "Abort"
                        }
                    }) ,
                    actions: function(node, action, options) {
                        clearSelection(); //disable browser internal line selection if user selected multiple rows using shift. TODO: catch shift globally and do this
                        var tree = $('#treetable_active').fancytree('getTree');
                        var selected = tree.getSelectedNodes();
                        $.extend(selected,node);
                        if (selected.length == 0 && !node ) {
                            dhtmlx.alert("Please select row");
                            return;
                        }
                        if (action == "details") {
                            var jobid = (node.data["job_id"]); //jobid contains splitid, sort_family_name is the id of mother job without splitd
                            var url = "logviewer.html?job_id=" + jobid;
                            window.open(url, '_blank');
                        }
                        if (action == "abort") {
                           console.log(selected)
                           jobCommand(selected, "abort");
                        }
                        if (action.indexOf("prio") ){
                           console.log(selected)
                           
                        }
                        

                    }
                }//contextmenu
            

        })

    }

    function filterHistoryList(the_list) {
        
        var filtered = the_list;
        for (i = 0; i < m_userpermissions.length; i++) {
            if (m_userpermissions[i]["key"] == "FILTER_WORKFLOW_NAME") {
                if (filtered == the_list) {
                    filtered = [];
                }
                for (idx = 0; idx < the_list.length; idx++) {
                    var name = the_list[idx]["workflow"];
                    var regex = new RegExp(m_userpermissions[i]["value"]["filter"], 'gi');
                    if (name.match(regex)) {
                        filtered.push(the_list[idx]);
                    }
                }
            }
        }
        return filtered;

    }


    function handleContextMenueClick(a,b,c){
        console.log(a,b,c)
    }
    function getContextMenuHistoryGrid(allpossible){
        var contextmenu = {};
        
        var _filter = _getObjectByValue(m_userpermissions,"FILTER_JOBSTATUS_BUTTONS");
        if (_filter.length > 0){
            var regex = new RegExp( _filter[0]["value"]["filter"], 'gi' );
            console.log("Displaying filtered list of buttons, regex: ", regex);
            for (var _idx in allpossible){
               if (allpossible[_idx]){
                    if (allpossible[_idx].name.match(regex)){
                        console.log(allpossible[_idx]);
                        var newitem = {};
                        newitem[_idx] = allpossible[_idx];
                        $.extend(contextmenu, newitem);
                        console.log(contextmenu);
                    }
               } 
            }
            return contextmenu;
        }else{
            //just render all btns
            console.log("Displaying unfiltered list of menu buttons" );
            contextmenu = allpossible;
            return contextmenu;
        }
    }
    
    function buildHistoryGrid() {
        
        var sourceUrl = "/gethistoryjobsajax_treegrid?filtercol=job_end&direction=des&count=200";
        //var sourceUrl = "testdata.xml";
        $("#treetable_history").fancytree({
            extensions: ["contextMenu", "table", "gridnav", "multi"],
            checkbox: false,
            titlesTabbable: false, // Add all node titles to TAB chain
            source: {
                url: sourceUrl,
                cache: true,
            },
            icon: false,
            multi: { //multiselct
                mode: ""
            },
            modifyChild: function(event, data) {
                //reset all odd even row colors
                var rootNode = $("#treetable_history").fancytree("getRootNode");
                var oldnodes = rootNode.children;

                for (i = 0; i < oldnodes.length; i++) {
                    if (i % 2 == 0) {
                        oldnodes[i].toggleClass("ev_dhx_skyblue", false)
                        oldnodes[i].toggleClass("odd_dhx_skyblue", true)
                    } else {
                        oldnodes[i].toggleClass("odd_dhx_skyblue", false)
                        oldnodes[i].toggleClass("ev_dhx_skyblue", true)
                    }
                }
            },
            renderColumns: function(event, data) {
                var node = data.node;
                if (data.node.extraClasses == null) { //need to do this whenever rowcount changes -->
                    if (data.node.getIndex() % 2 == 0) {
                        //node.removeClass = ("odd_dhx_skyblue");//apply dthmlx style to node
                        node.toggleClass("ev_dhx_skyblue"); //apply dthmlx style to node
                    } else {
                        //node.removeClass = ("ev_dhx_skyblue");//apply dthmlx style to node
                        node.toggleClass("odd_dhx_skyblue"); //apply dthmlx style to node
                    }
                }
                node.addClass("hist_row"); //for context menu

                $tdList = $(node.tr).find(">td");
                // (index #0 is rendered by fancytree (title node))
                //$tdList.eq(0).text(node.data.state);
                $tdList.eq(1).html("<div class='celltext'>" + node.data.workflow + "</div>"); //.addClass("alignRight");
                $tdList.eq(2).html("<div class='celltext'>" + node.data.job_start + "</div>");
                $tdList.eq(3).html("<div class='celltext'>" + node.data.duration + "</div>");
                $tdList.eq(4).html("<div class='celltext'>" + node.data.job_end + "</div>");
                $tdList.eq(5).html("<div class='celltext'>" + node.data.file + "</div>");
                var outcome = node.data.outcome.substring(0, 1000);
                if (outcome.length == 10000) {
                    dhtmlx.message("Detected oversized outcome in job, consider deleting it.\nFile: " + node.data.file + " \nDate Start: " + node.data.job_start);
                    outcome += " (text was truncated by webinterace...) "
                }
                $tdList.eq(6).html("<div class='celltext' title='"+node.data.outcome.substring(0, 1000)+"'>" + node.data.outcome.substring(0, 1000) + "</div>"); //outcome can be lengthy
            },
            init: function(event, data) {
                //ENABLE RESIZE COLUMNS
                $("#treetable_history").colResizable({
                    resizeMode: 'fit',
                    hoverCursor: "col-resize",
                    dragCursor: "col-resize",
                    postbackSafe: true,
                    useLocalStorage: true,
                    minWidth: 10,
                    liveDrag: true,
                });
            },
            postProcess: function(event, data) {
                // transform gethistoryjobsajax result into tree compatible
                // data is a treegrid specific object
                console.log("POSTPROCESS")
                data["result"] = filterHistoryList(data["response"]["data"]) //setting data["result"] means override the originally loaded data

            },
            table: {
                indentation: 15,
                nodeColumnIdx: 0,
            },
            gridnav: {
                autofocusInput: false,
                handleCursorKeys: true
            },
            select: function(event, data) {
                if (data.node.isSelected()) {
                    data.node.addClass("rowselected");
                } else {
                    data.node.removeClass("rowselected");
                }
            },
            contextMenu: {
                selector: "hist_row",
                menu: getContextMenuHistoryGrid( 
                    {
                        "details": {
                            "name": "Job Details"
                        },
                        "resubmit": {
                            "name": "Resubmit from Start"
                        },
                        "delete": {
                            "name": "Delete this job"
                        },
                        "delsel": {
                            "name": "Delete all selected"
                        },
                    }) ,
                actions: function(node, action, options) {
                        if (action == "details") {
                            var jobid = (node.data["job_id"]); //jobid contains splitid, sort_family_name is the id of mother job without splitd
                            var url = "logviewer.html?job_id=" + jobid;
                            window.open(url, '_blank');
                        }
                        if (action == "delete") {
                            $("#treetable_history").fancytree("getTree").selectAll(false); //unselect all nodes
                            node.setSelected(); //select the one that was right clickeds
                            click_b_header("b_delsel");
                        }
                        if (action == "delsel") {
                            click_b_header("b_delsel");
                        }
                        if (action == "resubmit") {
                            var tree = $('#treetable_history').fancytree('getTree');
                            var selected = tree.getSelectedNodes();
                            selected.forEach(function(node) {
                                resubmit_job(node["data"]["guid"]);
                            })

                        }

                    }
                }//contextmenu
            
        })

        //search btn
        $('input[name=search]').bind("enterKey", function(e) {
            //iterate all search fields
            var search_obj = {};
            for (i = 0; i < $("input[name=search]").length; i++) {
                var input = $("input[name=search]")[i];
                match = $.trim(input.value);
                var keyname = input.placeholder.toLowerCase();
                if (match) {
                    search_obj[keyname] = (match)

                }
            }

            var tree = $('#treetable_history').fancytree('getTree');
            tree.reload({
                url: "/gethistoryjobsajax_treegrid?filtercol=job_end&direction=des&count=200&filterobj=" + JSON.stringify(search_obj),
                cache: false
            });

        });

        $("input[name=search]").keyup(function(e) {
            if (e.keyCode == 13) {
                $(this).trigger("enterKey");
            }
        });

    } //buildhistorygrid

    function delete_jobs(array_of_rows) {

        var selectedRowIds = runningJobGrid.getSelectedRowId().split(',');
        selectedRowIds.forEach(function(rId) {
            var jobObj = runningJobGrid.getUserData(rId, "jobobject");
            var splitid = parseInt(runningJobGrid.cells(rId, 9).getValue());
            var postBody = {
                "action": pause,
                "split": splitid
            };
            socket.emit("pausejob", JSON.stringify({
                "id": jobObj.job_id,
                "body": postBody
            })); //note, custom structure for socket.emit messages
            dhtmlx.message("Command " + pause + " emitted:" + JSON.stringify(postBody))
        })
    }

    function saveLayoutSizes(dhxLayout, name) {
        //store layout cells height and with into html5 storage (in percentage of document height)
        var aw = (dhxLayout.cells("a").getWidth() / document.body.scrollWidth);
        var ah = (dhxLayout.cells("a").getHeight() / document.body.scrollHeight);
        var bw = (dhxLayout.cells("b").getWidth() / document.body.scrollWidth);
        var bh = (dhxLayout.cells("b").getHeight() / document.body.scrollHeight);
        localStorage.setItem(name + "_aw", aw);
        localStorage.setItem(name + "_ah", ah);
        localStorage.setItem(name + "_bw", bw);
        localStorage.setItem(name + "_bh", bh);

    }

    function restoreLayoutSizes(dhxLayout, name) {
        if (localStorage.getItem(name + "_aw")) {
            var aw = localStorage.getItem(name + "_aw");
            var ah = localStorage.getItem(name + "_ah");
            var bw = localStorage.getItem(name + "_bw");
            var bh = localStorage.getItem(name + "_bh");
            dhxLayout.cells("a").setWidth(aw * document.body.scrollWidth);
            dhxLayout.cells("a").setHeight(ah * document.body.scrollHeight);
            dhxLayout.cells("b").setWidth(bw * document.body.scrollWidth);
            dhxLayout.cells("b").setHeight(bh * document.body.scrollHeight);
        }
    }

    function onHeaderClick() {
        window.open("http://www.ffastrans.com");
    }

    function openLogViewer(dhxgrid) {
        var tree = $('#treetable_history').fancytree('getTree');
        var selected = tree.getSelectedNodes();

        if (selected.length == 0) {
            dhtmlx.alert("Please select rows to view Log");
            return;
        }

        var win_offset = 0;
        selected.forEach(function(treeNode) {
            var jobObj = treeNode.data;

            var dhxwins = new dhtmlXWindows();
            //dhxwins.attachViewportTo(window.parent.document.body);
            var win = dhxwins.createWindow("Workflow", 50 + win_offset, 150 + win_offset, 1200, 800);
            win_offset += 30;
            win.setText("Log ");

            var logGrid = win.attachGrid();
            logGrid.setImagesPath("../dependencies/dhtmlx/imgs/");
            logGrid.setHeader("Time,Processor,Host,PID,Message"); //the headers of columns
            logGrid.attachHeader("#text_filter,#text_filter,#text_filter,#text_filter,#text_filter");
            logGrid.setInitWidthsP("10,10,10,5,*"); //the widths of columns
            logGrid.setColAlign("left,left,left,left.left"); //the alignment of columns
            logGrid.setColTypes("ed,ed,ed,ed,ed"); //the types of columns
            logGrid.setColSorting("str,str,str,int,str"); //the sorting types
            logGrid.enableMultiline(true);
            logGrid.init(); //finishes initialization and renders the grid on the page

            if (jobObj["job_id"]) {
                //we have a job_id that eases the life of finding jobs
                var url = "/logparser?job_id=" + encodeURI(jobObj["job_id"]) + "&wf_name=" + encodeURI(jobObj["wf_name"]);
                logGrid.load(url, "json")
            } else {
                var file = (dhxgrid.cells(rId, dhxgrid.getColIndexById("file")).getValue());
                var job_end = (dhxgrid.cells(rId, dhxgrid.getColIndexById("job_end")).getValue());
                var job_start = (dhxgrid.cells(rId, dhxgrid.getColIndexById("job_start")).getValue());
                var wf_name = (dhxgrid.cells(rId, dhxgrid.getColIndexById("wf_name")).getValue());
                //we don'T have a jobid, server will need to find files based on the infos we have. this is currently being changed in ffastrans
                var url = ("/logparser?file=" + encodeURI(file) + "&job_end=" + encodeURI(job_end) + "&job_start=" + encodeURI(job_start) + "&wf_name=" + encodeURI(wf_name));
                logGrid.load(url, "json");
            }
            win.show();
            //win.attachURL("worfklowcanvas.html?jobid=element&logfolder=element");
        });

    }

    function resubmit_job(job_id) {
        //get all workflows from server and start main with the workflow of interest
        job_id = job_id.split("~")[0];
        var _url = "/getjobdetails?jobid=" + job_id;
        $.ajax({
            url: build_new_api_url(_url),
            type: "GET",
            crossDomain: true,
            success: function(response) {

                if (response['wf_object'].length == 0) {
                    alert("Did not get any workflow in job from FFASTRANS API");
                } else {
                    var postBody = {};
                    postBody.start_proc = response["nodes"]["start"]["id"];
                    postBody.wf_id = response["workflow"]["id"];
                    postBody.inputfile = response["sources"]["localized_file"];
                    postBody.variables = response["variables"];
                    $.ajax({
                        url: buildUrl(m_serverconfig['STATIC_START_JOB_URL']),
                        type: "POST",
                        crossDomain: true,
                        data: JSON.stringify(postBody),
                        success: function(response) {
                            dhtmlx.message(postBody.inputfile + " was submitted")
                        },
                        error: function(xhr, status) {
                            dhtmlx.alert("Error submitting workflow: " + xhr.responseText);
                        }
                    });
                }
            },
            error: function(xhr, status) {
                alert("ERROR getting workflow of job " + job_id + ", possibly FFASTRANS API is offline. ");
            }
        });
    }

    function pauseResumeJob(pause, httpMethod) {
        //Emits socket.io comman to webserver (the api request is made on the webserver not the client) pause is set to either pause or resume.
        if (!runningJobGrid.getSelectedRowId()) {
            dhtmlx.alert("Please select a Job to " + pause);
            return;
        }
        var selectedRowIds = runningJobGrid.getSelectedRowId().split(',');
        selectedRowIds.forEach(function(rId) {
            var jobObj = runningJobGrid.getUserData(rId, "jobobject");
            var splitid = parseInt(runningJobGrid.cells(rId, 9).getValue());
            var postBody = {
                "action": pause,
                "split": splitid
            };
            socket.emit("pausejob", JSON.stringify({
                "id": jobObj.job_id,
                "body": postBody
            })); //note, custom structure for socket.emit messages
            dhtmlx.message("Command " + pause + " emitted:" + JSON.stringify(postBody))
        })
    }

    function jobCommand(fancy_node_array, action, value) {
        //only available in ffastrans 9.4>//TODO: wait for the new version call, then do version detection
        console.log("aborting", fancy_node_array)
        fancy_node_array.forEach(function(node) {
            if (node["data"]["state"] == "Queued") {
                dhtmlx.message("Sorry, Queued Jobs cannot be aborted yet");
                return;
            }
            var postBody = {
                "action": action,
                "split_id": node.data.split_id
            };
            if (value){
                postBody["value"] = value;
            }
            $.ajax({
                url: ("/proxy" + m_serverconfig['STATIC_START_JOB_URL']) + node.data.job_id,
                type: "PUT",
                context: this,
                data: JSON.stringify(postBody),
                success: function(response) {
                    dhtmlx.message("Success " + action + " " + node.data.job_id);
                },
                error: function(xhr, status) {
                    dhtmlx.message("ERROR aborting job, contact developer. Status:" + status);
                }
            });
        })

    }

    function abortJob() {
        if (!runningJobGrid.getSelectedRowId()) {
            dhtmlx.alert("Please select a Job to abort");
            return;
        }
        var selectedRowIds = runningJobGrid.getSelectedRowId().split(',');
        selectedRowIds.forEach(function(rId) {
            var rowId = rId;
            var jobObj = runningJobGrid.getUserData(rowId, "jobobject");
            $.ajax({
                url: ("/proxy" + m_serverconfig['STATIC_START_JOB_URL']) + jobObj.job_id,
                type: "DELETE",
                context: this,
                success: function(response) {
                    dhtmlx.message("Aborted " + jobObj.job_id);
                },
                error: function(xhr, status) {
                    dhtmlx.message("ERROR aborting job, contact developer. Status:" + status);
                }
            });
        }) //foreachjob
    }

    function getQueuedJobs(targetGridObj) {

        $.ajax({
            url: buildUrl(m_serverconfig['STATIC_GET_QUEUED_JOBS_URL']),
            type: "GET",
            crossDomain: true,
            dataType: "json",
            context: this,
            success: function(response) {
                mainLayout.cells("a").progressOff();
            },
            error: function(xhr, status) {
                dhtmlx.message("ERROR getting queued jobs, possibly FFASTRANS API is offline.  ");
            }
        });
    }

    function applyWorkflowFilter(o_job) {
        //returns true or false based on userpermission job filter
        for (i = 0; i < m_userpermissions.length; i++) { //iterate all permissions
            if (m_userpermissions[i]["key"] == "FILTER_WORKFLOW_NAME") {

                var regex = new RegExp(m_userpermissions[i]["value"]["filter"], 'gi');
                if (o_job["workflow"].match(regex)) {

                    return true;
                } else {
                    return false;
                }
            }
        }
        return true; //if there is no filter, render all jobs
    }

    function addActiveJobsToGrid(targetGridObj, jobArray, qstate) {

        var rootNode = $("#treetable_active").fancytree("getRootNode");
        var tree = $("#treetable_active").fancytree("getTree");
        //add or update new jobs
        var activeJobIds = [];
        for (y = 0; y < jobArray.length; y++) {
            if (applyWorkflowFilter(jobArray[y]) == false) {
                continue;
            }

            var key = jobArray[y]["key"].toString();
            activeJobIds.push(key);
            var existing = tree.getNodeByKey(key);
            if (existing) {
                existing.data = jobArray[y];
                existing.renderTitle(); //forces reload of node
            } else {
                rootNode.addChildren(jobArray[y]);
            }
        }
        //remove orphand
        var oldnodes = rootNode.children;
        if (oldnodes) {
            for (a = 0; a < oldnodes.length; a++) {
                if (oldnodes[a]["data"]["state"] == qstate) {
                    if (activeJobIds.indexOf(oldnodes[a]["key"]) == -1) {
                        oldnodes[a].remove();
                    }
                }

            }
        }
        //take care about grid sorting
        sortGrid("treetable_active", m_lastsortelementid, m_lastsortdir);

    }

    /* HELPERS */
    function hashCode(string) {
        //this creates a hash from a stringified object, it is used to workaround and create missing jobids from ffastrans version 0.9.3
        var hash = 0,
            i,
            chr;
        if (string.length === 0)
            return hash;
        for (i = 0; i < string.length; i++) {
            chr = string.charCodeAt(i);
            hash = ((hash << 5) - hash) + chr;
            hash |= 0; // Convert to 32bit integer
        }
        return hash;
    };

    function getDurationStringFromDates(start_date, end_date) {
        var delta = Math.abs(new Date(end_date) - new Date(start_date)) / 1000; // get total seconds between the times
        var days = Math.floor(delta / 86400); // calculate (and subtract) whole days
        delta -= days * 86400; // calculate (and subtract) whole hours
        var hours = Math.floor(delta / 3600) % 24;
        delta -= hours * 3600; // calculate (and subtract) whole minutes
        var minutes = Math.floor(delta / 60) % 60;
        delta -= minutes * 60; // what's left is seconds
        var seconds = delta % 60; // in theory the modulus is not required
        return pad(hours) + ":" + pad(minutes) + ":" + pad(seconds);
    }

    function pad(n, z) { //add leading zero if there is none
        z = z || '0';
        n = n + '';
        return n.length >= 2 ? n : new Array(2 - n.length + 1).join(z) + n;
    }

    function configureJobGrid(dhtmlxGridObj) {
        //todo: this is only for activejobgrid
        dhtmlxGridObj.setImagePath("../dependencies/dhtmlx/imgs");
        //dhtmlxGridObj.attachHeader("#text_filter,#text_filter,#text_filter,#text_filter,#text_filter,#text_filter,#text_filter,#text_filter,#text_filter,#text_filter,#text_filter,#text_filter");
        dhtmlxGridObj.setColAlign("left,left,left,left,left,left,left,left,left,left,left"); //the alignment of columns
        dhtmlxGridObj.setColTypes("ro,ed,ed,ed,ed,ro,ed,ed,ed,ed,ed,ed,ed"); //the types of columns
        dhtmlxGridObj.setColSorting("str,str,str,str,str,str,str,str,str,str,str,str"); //the sorting types
        dhtmlxGridObj.enableMultiselect(true);
        dhtmlxGridObj.init(); //finishes initialization and renders the grid on the page
    }

    function buildUrl(what) {
        if (JSON.parse(m_serverconfig['STATIC_USE_PROXY_URL'])) {
            return "/proxy" + what;
        } else {
            var _url = "http://" + m_serverconfig['STATIC_API_HOST'] + ":" + m_serverconfig['STATIC_API_PORT'] + what;
            return _url;
        }
        //old, delete at next iteration
    }

    /* NO PROXY MODE */
    function getQueuedJobs(targetGridObj) {
        $.ajax({
            url: buildUrl(m_serverconfig['STATIC_GET_QUEUED_JOBS_URL']),
            type: "GET",
            crossDomain: true,
            dataType: "json",
            context: this,
            success: function(response) {
                addQueuedJobsToGrid(targetGridObj, response.queue);
                mainLayout.cells("a").progressOff();
            },
            error: function(xhr, status) {
                dhtmlx.message("ERROR getting queued jobs, possibly FFASTRANS API is offline.  ");
            }
        });
    }

    function getActiveJobs(targetGridObj) {
        $.ajax({
            url: buildUrl(m_serverconfig['STATIC_GET_RUNNING_JOBS_URL']),
            type: "GET",
            crossDomain: true,
            dataType: "json",
            context: this,
            success: function(response) {
                addActiveJobsToGrid(targetGridObj, response.jobs);
                mainLayout.cells("a").progressOff();
            },
            error: function(xhr, status) {
                dhtmlx.message("ERROR getting jobs, possibly FFASTRANS API is offline.  ");
            }
        });
    }

    function getFinishedJobs(targetGridObj) {

        $.ajax({
            url: buildUrl(m_serverconfig['STATIC_GET_FINISHED_JOBS_URL']),
            type: "GET",
            crossDomain: true,
            dataType: "json",
            context: this,
            success: function(response) {

                addHistoryJobsToGrid(targetGridObj, response.history);
                mainLayout.cells("b").progressOff();
            },
            error: function(xhr, status) {
                dhtmlx.message("ERROR getting jobs, possibly FFASTRANS API is offline.  ");

            }
        });
    }
    /* /NO PROXY MODE */
    function build_new_api_url(what) {
        if (JSON.parse(m_serverconfig['STATIC_USE_PROXY_URL'])) {
            return "/new_proxy" + what;
        } else {
            var _url = "http://" + m_serverconfig['STATIC_API_HOST'] + ":" + m_serverconfig['STATIC_API_NEW_PORT'] + what;
            return _url;
        }
    }

    function sortGrid(whichGrid, src_element_id, force_order) {
        src_element = document.getElementById(src_element_id);
        if (!src_element) {
            console.error("Error in sorting, finding element with id: " + src_element)
            return;
        }
        var whichColumn = src_element.getAttribute("name");
        var tree = $('#treetable_active').fancytree('getTree');
        if (whichGrid != "treetable_active") {
            tree = $('#treetable_history').fancytree('getTree');
        }

        if (!force_order) {

            if (src_element.dataset["sort_dir"] == "asc") {
                src_element.dataset["sort_dir"] = "des";
            } else {
                src_element.dataset["sort_dir"] = "asc";
            }
        } else {
            src_element.dataset["sort_dir"] = force_order
        }
        //remember the sorting
        m_lastsortelementid = src_element_id;
        m_lastsortdir = src_element.dataset["sort_dir"];
        //apply the sorting
        tree.getRootNode().sortChildren(function(a, b) {
            if (src_element.dataset["sort_dir"] == "asc") {
                return (a.data[whichColumn] + "").localeCompare(b.data[whichColumn])
            } else {
                return (b.data[whichColumn] + "").localeCompare(a.data[whichColumn])
            }

        }, true);

        localStorage.setItem("m_lastsortelementid", m_lastsortelementid);
        localStorage.setItem("m_lastsortdir", m_lastsortdir);
    }

        
    function clearSelection() {
    //used for clearing all unwanted browser text selections
        if(document.selection && document.selection.empty) {
            document.selection.empty();
        } else if(window.getSelection) {
            var sel = window.getSelection();
            sel.removeAllRanges();
        }
    }
</script>

<body onload="loadserverconfig()">

    <div style="display:none">
        <!-- global hiding div prevents showing raw tables before dhtmlx layout attaches the template divs -->
        <!-- THIS DIV CONTAINS THE FINISHED JOBGRID FANCYTREE TEMPLATE -->
        <div id="active_div" style="" class="gridbox_dhx_skyblue gridbox">
            <table id="treetable_active" class="obj">
                <colgroup>
                    <col width="5%"></col>
                    <col width="10%"></col>
                    <col width="5%"></col>
                    <col width="10%"></col>
                    <col width="10%"></col>
                    <col width="10%"></col>
                    <col width="10%"></col>
                </colgroup>
                <thead class="dhtmlxMenu_dhx_skyblue_Middle sticky" style="border:none">
                    <tr>
                        <th id="active-state" name="state" onclick="sortGrid('treetable_active',this.id)" data-sort_dir="" >State</th>
                        <th id="active-workflow" name="workflow" onclick="sortGrid('treetable_active',this.id)" data-sort_dir="">Workflow</th>
                        <th id="active-job_start" name="job_start" onclick="sortGrid('treetable_active',this.id)" data-sort_dir="">Start</th>
                        <th id="active-file" name="file" onclick="sortGrid('treetable_active',this.id)" data-sort_dir="">Source</th>
                        <th id="active-proc" name="proc" onclick="sortGrid('treetable_active',this.id)" data-sort_dir="">Processor@Host</th>
                        <th id="active-status" name="status" onclick="sortGrid('treetable_active',this.id)" data-sort_dir="">Status</th>
                        <th id="active-progress" name="progress" onclick="sortGrid('treetable_active',this.id)" data-sort_dir="">Progress</th>
                    </tr>
                </thead>
            </table>
        </div>



        <!-- THIS DIV CONTAINS THE FINISHED JOBGRID FANCYTREE TEMPLATE -->
        <div id="history_div" style="" class="gridbox_dhx_skyblue gridbox">
            <table id="treetable_history" class="obj">
                <colgroup>
                    <col width="5%"></col>
                    <col width="10%"></col>
                    <col width="10%"></col>
                    <col width="10%"></col>
                    <col width="10%"></col>
                    <col width="10%"></col>
                    <col width="10%"></col>
                </colgroup>
                <thead class="sticky dhtmlxMenu_dhx_skyblue_Middle" style="border:none">
                    <tr class="">
                        <th><input placeholder="State" style="width:50px;height:18px;margin-left:5px" type="search" name="search" incremental autocomplete="off"></th>
                        <th><input placeholder="Workflow" style="width:90px;height:18px;margin-left:5px" type="search" name="search" incremental autocomplete="off"></th>
                        <th><input placeholder="Start" style="width:70px;height:18px;margin-left:5px" type="search" name="search" incremental autocomplete="off"></th>
                        <th>Duration</th>
                        <th><input placeholder="End" style="width:70px;height:18px;margin-left:5px" type="search" name="search" incremental autocomplete="off"></th>
                        <th><input placeholder="File" style="width:150px;height:18px;margin-left:5px" type="search" name="search" incremental autocomplete="off"></th>
                        <th><input placeholder="Outcome" style="width:150px;height:18px;margin-left:5px" type="search" name="search" incremental autocomplete="off"></th>
                    </tr>
                </thead>
            </table>
        </div>
    </div><!-- global hiding div -->
</body>
