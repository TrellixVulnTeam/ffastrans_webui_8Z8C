<html>

	<head>
		<meta charset="UTF-8">
			<script src="../../dependencies/jquery/jquery.js"></script>
			
			<script src="/socket.io/socket.io.js"> </script>
			<script src="jsmpeg-master/jsmpeg.min.js"> </script>
			<link rel="stylesheet" type="text/css" href="css/main.css" ></link>
			<link rel="stylesheet" type="text/css" href="../../dependencies/fontawesome/css/all.css"></link>
			
			<style>
			.player-btns {
				display:inline-block;

			} 
			

			</style>
			
			<script>
var socket = io(); 
var player;
reversePlayInterval = null;

function load(){
			var query = window.location.search.substring(1);
			query = parse_query_string(query);
			var buf = [];
			
		    player = new JSMpeg.Player(null,//null
				{
					source: JSMpegWritableSource,
					
					videoBufferSize: 1024*1024 * 10,
					audioBufferSize: 256*1024 * 10,
					disableWebAssembly:false,
					pauseWhenHidden:false,
					canvas:document.getElementById('myCanvas'),
					loop: true, 
					autoplay: true, 
					onVideoDecode:function(what,time){
						//console.log("Videodecode",what,time)
					}
				});
				
			var statusInterval = window.setInterval(function(){
				socket.emit("player", JSON.stringify({"getstatus":true})); 
			},250);
			
			socket.emit("player", JSON.stringify({
                "file":query.file
			})); 
			
			socket.on('binarydata', function (data) {
				// pretend you are getting data as follows
					player.source.write(data,function(){});
					
			});
			socket.on('playererror', function (data) {
				// pretend you are getting data as follows
					alert(data)
					
			});
			socket.on('setstatus', function (data) {
				// pretend you are getting data as follows
				var status = data;	
				status.root.position //navbar in percent
				console.log(status)
				var _framerate = getFramerateFromStatus(status);
				var _timecode = SMPTEToString(secondsToSMPTE(status.root.time,_framerate));
				document.getElementById("currentTime").value = _timecode;
				var _duration = SMPTEToString(secondsToSMPTE(status.root.length,_framerate));
				document.getElementById("totalTime").value = _duration;
				try{
					if (status.root.rate >= 1){
						document.getElementById("rate_display").innerHTML = Math.round(status.root.rate);					
					}else{
						var _rt = status.root.rate.toFixed(2);
						document.getElementById("rate_display").innerHTML = _rt;
					}
				}catch(ex){
				
				}
				if ($('#slider:hover').length == 0){
					//prevent slider update on hover
					var percentage = status.root.position * 100;
					document.getElementById("slider").value = percentage;
				}
				//fa-play-circle //iconPlay
				//if (status.root.state == "playing"){
					$( "#iconPlay" ).toggleClass( "fa-play-circle ", status.root.state != "playing" );
					$( "#iconPlay" ).toggleClass( "fa-pause-circle ", status.root.state == "playing" );
				//}
				//document.getElementById("buttonPlay").value = capitalizeFirstLetter(status.root.state);
				
			});
			
			//EVENTS
			attachEvents()
}

function attachEvents(){
		   document.getElementById("slider").addEventListener ('change', function (evt) {
		   console.log("Slider change",evt)
		   playerCommandSeek(document.getElementById("slider").value + '%');
		   //TODO: find a way to get current pos from event instead of dom element. dom ele can be cancelled
		   evt.cancelBubble = true;
		   evt.preventDefault();
	});
}

function getFramerateFromStatus(status){
	//we cannot take the framerate from jsmpeg because vlc might play a different source framerate
	for (var catIdx in status.root.information.category){
		try{
			var infoObj = status.root.information.category[catIdx];
			var infoObj = infoObj.info;
			//TODO: support audio only?
			var _framerate = infoObj.find((info) => info.name == "Frame rate");
			return _framerate["$t"];
		}catch(ex){}	
	}

}

	
function parse_query_string(query) {
    var vars = query.split("&");
    var query_string = {};
    for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split("=");
        var key = decodeURIComponent(pair[0]);
        var value = decodeURIComponent(pair[1]);
        //If first entry with this name 
		if (typeof query_string[key] === "undefined") {
            query_string[key] = decodeURIComponent(value);
           // If second entry with this name
        } else if (typeof query_string[key] === "string") {
            var arr = [query_string[key], decodeURIComponent(value)];
            query_string[key] = arr;
            //If third or later entry with this name
        } else {
            query_string[key].push(decodeURIComponent(value));
        }
    }
    return query_string;
}


function simplePlayerCommand(what){
	socket.emit("player", JSON.stringify({
                "command": what
			}));
}

function playerCommandSetRate(newRate){
	//simplePlayerCommand("pl_forceresume");
	socket.emit("player", JSON.stringify({
                "command": "rate",
                "val": encodeURIComponent(newRate)
			}));
}

function slower(){
	var maxspeed = 0.24;
	var currentRate = document.getElementById("rate_display").innerHTML;
	currentRate = parseFloat(currentRate);
	if (currentRate - 0.25 <= maxspeed){
		//cannot play reverse
		return;
	}
	try{
		currentRate = currentRate - 0.25;
		console.log("Setting rate to ", currentRate)
		playerCommandSetRate(currentRate);
		
	}catch(ex){
		dhtmlx.alert("Current Rate is not a number: " +currentRate);
	}
}

function faster(){
	var maxspeed = 32;
	var currentRate = document.getElementById("rate_display").innerHTML;
	currentRate = parseInt(currentRate);
	if (currentRate + 1  >= maxspeed){
	
		return;
	}
	try{
		currentRate = currentRate * 2;
		playerCommandSetRate(currentRate);
	}catch(ex){
		dhtmlx.alert("Current Rate is not a number: " +currentRate);
	}
}

function playerCommandSeek(where){

		//disable slider updates, otherwise seek only works sporadically

		socket.emit("player", JSON.stringify({
                "command": "seek",
                "val": encodeURIComponent(where)
            }));
		
		//playerCommand("pl_forceresume");
		//window.setTimeout(	function(){playerCommand("pl_forcepause")},300);
		
}

function playPause(){
	if (reversePlayInterval){
		window.clearInterval(reversePlayInterval);
	}
	playerCommandSetRate("1");
	socket.emit("player", JSON.stringify({
                "command": "play"
            }));
	<!-- TODO: this does not catch up with vlc but makes the impression that we pause immediately -->
	<!-- if (player.isPlaying) --> -->
		<!-- <!-- player.pause(); --> -->
	<!-- else -->
		<!-- setTimeout(function(){player.play()},1000); -->
}

/** Convert seconds to SMPTE timecode JSON object, example input is html video.currentTime */
function secondsToSMPTE(seconds, framerate) {
    var f = Math.floor((seconds % 1) * framerate);
    var s = Math.floor(seconds);
    var m = Math.floor(s / 60);
    var h = Math.floor(m / 60);
    m = m % 60;
    s = s % 60;

    return {h: h, m: m, s: s, f: f};
}

/** Pretty print SMPTE timecode JSON object */
function SMPTEToString(timecode) {
    if (timecode.h < 10) { timecode.h = "0" + timecode.h; }
    if (timecode.m < 10) { timecode.m = "0" + timecode.m; }
    if (timecode.s < 10) { timecode.s = "0" + timecode.s; }
    if (timecode.f < 10) { timecode.f = "0" + timecode.f; }
	console.log(timecode.f)
    return timecode.h + ":" + timecode.m + ":" + timecode.s;// + ":" + timecode.f;
}

function capitalizeFirstLetter(string) {
  return string.charAt(0).toUpperCase() + string.slice(1);
}

</script>

		</head>
		<body onload="load()">
		<div style="float:left;width:80%">
			<div width="540px" height="500px" style="text-align: center;">
				<canvas id="myCanvas" width="540px" height="288px" style="width:100%;border-style: inset" class=""></canvas>
				
				<div id="controlTable" class="controltable">
					<div id="seekContainer">
						<div style="float:left">Position: <input style="width:60px" id="currentTime"  value='00:00:00'/></div>
						<div style="display:inline">Rate: <div id="rate_display" style="display:inline">1</div><div style="display:inline">x</div></div>
						<div style="float:right">Duration: <input style="width:60px" id="totalTime" style="float:right" class="" value="00:00:00" style="display:flex;float:right"/></div>
						<div class="slidecontainer">
							<input type="range" id="slider" style="width:100%" min="1" max="100" value="0" class="slider" onchange="">
						</div>
					</div>
					<div id="controlButtons" class="vertical-center">
						<div class="player-btns">
						<i style="margin:3px" title="-10s" id="iconStepMinus" 		class="fas fa-step-backward 	fa-3x" onclick="playerCommandSeek('-10s')"></i>
						<i style="margin:3px" title="slower" id="iconSlow" 		class="fas fa-backward 				fa-3x" onclick="slower()"></i>
						<i style="margin:3px" title="play/pause" id="iconPlay" 	class="fas fa-play-circle 					fa-3x" onclick="playPause()"></i>
						<i style="margin:3px" title="faster" id="iconFaste" 		class="fas fa-forward 				fa-3x" onclick="faster()"></i>
						<i style="margin:3px" title="-10s" id="iconStepPlus" 		class="fas fa-step-forward 	 	fa-3x" onclick="playerCommandSeek('+10s')"></i>
						
						</div>
					<!-- </div> -->

					</div>
				</div>
			</div><!-- player -->
			</div><!-- dev -->
			<div style="float:right;width:18%">
				<div style="height:60%">
					File Properties:
				</div>
				<div style="height:30%">
					<input style="width:100px;height:100px"  type="submit" value="Select > "></input>
				</div>
			</div>
			</body>
		</html>