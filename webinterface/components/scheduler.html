<html>
<head>
<script src="/socket.io/socket.io.js"></script>
<script src="../dependencies/dhtmlx/dhtmlx.js"></script>
<link rel="stylesheet" href="../dependencies/dhtmlx/dhtmlx.css" type="text/css"/> 
<script src="../dependencies/dhtmlx/vault/vault.js"></script>
<link rel="stylesheet" href="../dependencies/dhtmlx/vault/vault.css" type="text/css"/> 
<script src="../dependencies/jquery/jquery.js"></script>
<link rel="stylesheet" href="../dependencies/fontawesome/css/all.css"/>

<script type="text/javascript" src="../dependencies/shawnchin-jquery-cron-78118ba/cron/jquery-cron.js"></script>
<link type="text/css" href="../dependencies/shawnchin-jquery-cron-78118ba/cron/jquery-cron.css" rel="stylesheet" />


<link rel="stylesheet" href="../dependencies/codemirror/codemirror.css">
<script src="../dependencies/codemirror/codemirror.js"></script>
<script src="../dependencies/codemirror/mode/javascript/javascript.js"></script>
<style>
    /* it's important to set width/height to 100% for full-screen init */
    html, body {
        width: 100%;
        height: 100%;
        margin: 0px;
        overflow: hidden;
    }
    .CodeMirror { height: 100%; }

</style>
<script>
/* init SOCKET.IO */
var socket = io(); 

function twoDigits(d) {
    if(0 <= d && d < 10) return "0" + d.toString();
    if(-10 < d && d < 0) return "-0" + (-1*d).toString();
    return d.toString();
}

Date.prototype.toMysqlFormat = function() {
    return this.getFullYear() + "-" + twoDigits(1 + this.getMonth()) + "-" + twoDigits(this.getDate()) + " " + twoDigits(this.getHours()) + ":" + twoDigits(this.getMinutes()) + ":" + twoDigits(this.getSeconds());
};


function renderCron(_id,_initial){
    if (!_initial){
        _initial = "*/5 * * * *";
    }
    $("#sched"+_id+"").cron({
                                initial: _initial,
                                customValues: {
                                    "2 Minutes" : "*/2 * * * *",
                                    "5 Minutes" : "*/5 * * * *",
                                    "10 Minutes" : "*/10 * * * *",
                                }
                            })
}
//dhtmlx grid custom cell type
function eXcell_cron(cell){ //custom cell type for dhtmlx grid, used to show cron pattern
    if (cell){                // the default pattern
        this.cell = cell;
        this.grid = this.cell.parentNode.grid;
        //eXcell_ed.call(this); //uses methods of the "ed" type
    }
    this.edit = function(){
        //open cron editor
        var myWins= new dhtmlXWindows();
        var win = myWins.createWindow(Math.random(), 40,90, 400,400);
        win.setText("Frequency");
     
        var _menu = win.attachMenu({
            icons_path: "/webinterface/dependencies/dhtmlx/imgs/",
            items:[
                {id:"save", text:'<i class="fas fa-save"></i>OK'},
                {id:"add", text:'<i class="fas fa-folder-plus"></i>Add'},
                {id:"del", text:'<i class="fas fa-folder-minus"></i>Delete'},
            ]          
        });
        var _this = this;
        var _crongrid = win.attachGrid();
            _crongrid.setImagePath("/webinterface/dependencies/dhtmlx/imgs");                 
            _crongrid.setHeader("Schedules");
            _crongrid.setInitWidthsP("100");         
            _crongrid.setColAlign("left");         
            _crongrid.setColTypes("ro");            
            _crongrid.setColSorting("str");
            _crongrid.init();
            _crongrid.enableTooltips("false,false");
            var existing = this.getValue().split(",");
            //render existing cron entries
            for (i in existing){
                var _id = _crongrid.uid();
                _crongrid.addRow(_id,("<div id='sched"+_id+"'></div>"));
                renderCron(_id,existing[i]);
            }
            //TODO: load existing schedules from row userdata
            _menu.attachEvent("onClick", function(id, zoneId, cas){
                   if (id == "add"){
                        var _id = _crongrid.uid();
                        _crongrid.addRow(_id,("<div id='sched"+_id+"'></div>"));
                       renderCron(_id);
                   }
                  if (id == "save"){
                        var cronArray = [];
                        _crongrid.forEachRow(function(rid){
                            cronArray.push($("#sched"+rid+"").cron("value"));
                        });
                        _this.setCValue(cronArray,"foobar");  
                        win.close();
                        return;
                   }
                   if (id == "del"){
                        _crongrid.deleteSelectedRows()
                   }
                   
            });
        //this.setCValue("Such dir eine Frau","");  
        
        
    }
    this.setValue=function(val){
        /* actual data processing */
        this.setCValue(val,val);                                      
    }
    this.getValue=function(){
        console.log (this.cell)
        /* getting the value */
        return this.cell.innerHTML; 
    }
}

/* nests all other methods from the base class */
eXcell_cron.prototype = new eXcell;

</script>
<script>
/* GLOBALS */
var m_mainGrid,m_codemirror,m_lastSelectedWorkflow,m_allWorfklows = {},m_socketId;

/*load config from server*/
function loadserverconfig(){
   $.ajax({
        url:  ("/getserverconfig") ,
        type: "GET",
        success: function (response) {
            m_serverconfig = JSON.parse(response)
            init();
        },
        error: function (xhr, status) {
            dhtmlx.message("Fatal error, could not load serverconfig. " );
            document.body.innerHTML="Fatal error, could not load serverconfig. "+ xhr.responseText;
        }
    });
}

/* build basic page layout and init periodic job loading*/
function init(){
    //store clientid of socket.io in order to receive custom messages (e.g. job log)
    socket.on('socketid', function(msg){
       m_socketId = msg;
    });
    socket.on('logmessage', function(msg){
        //todo: create log window on demand and pass log message to this window.
       dhtmlx.message(msg)
    });    
    //main layout
    m_mainLayout = new dhtmlXLayoutObject({
        parent: document.body,  
        pattern: "2U"           
    });
    
    //m_mainLayout.setAutoSize("a", "a;b");//make left cell expand on resize
    
    m_mainLayout.cells("a").setMinWidth(50);
    m_mainLayout.cells("b").setMinWidth(50);
    m_mainLayout.cells("a").setMinHeight(50);
    m_mainLayout.cells("b").setMinHeight(50);  
    m_mainLayout.cells("a").setText("Schedule");
	m_mainGrid = m_mainLayout.cells("a").attachGrid();
    m_mainGrid.setImagePath("/webinterface/dependencies/dhtmlx/imgs/");                 
    m_mainGrid.setHeader("id, Enabled, Name, Description, Frequency,  Last Start, Created on,script,workflow");
    m_mainGrid.setColumnIds("id,enabled,job_name,job_description,cron,last_start,date_created,script,workflow");    
    m_mainGrid.setInitWidthsP("0,10,10,20,20,20,20,0,0,0");          
    m_mainGrid.setColAlign("left,left,left,left,left,left,left,left,left");       
    m_mainGrid.setColTypes("ed,ch,ed,txttxt,cron,ro,ro,ro,ro");               
    m_mainGrid.setColSorting("str,str,str,str,str,str,str,str,str");         
    m_mainGrid.init();    
	loadJobs(m_mainGrid);
    
	m_mainGridMenu = m_mainLayout.cells("a").attachMenu({                                               
		items:[
            {id:"save", text:"<i class='fas fa-save'></i>Save"},
            {id:"new", text:"New"},
			{id:"delete", text:"Delete"},
		]
	});
	
    m_mainGridMenu.attachEvent("onClick", function(id,ind){
        //create new job rows
        if (id=="new"){
            var newId = Math.random();
            m_mainGrid.addRow(newId,[newId,"false", "New Job", "", "*/5 * * * *",  "", new Date().toMysqlFormat(), "{}"])
        }
        if (id=="delete"){
            deleteJob(m_mainGrid.getSelectedRowId())
            
        }
        if (id=="save"){
            saveJobGrid();
        }
    })
    
    
    var detailsLayout = m_mainLayout.cells("b").attachLayout({
            pattern: "2E"  
    })
    detailsLayout.cells("a").setText("Documentation");
    
    detailsLayout.cells("a").attachObject("documentation");
    
    detailsLayout.cells("b").setText("Custom script");
    var scriptMenu = detailsLayout.cells("b").attachMenu({
            icons_path: "/webinterface/dependencies/dhtmlx/imgs/",
            items:[
                {id:"save", text:'<i class="fas fa-save"></i>Save'},
                {id:"start", text:'<i class="fas fa-play"></i>Test Run'}
            ]
        });
    
    scriptMenu.attachEvent("onClick", function(id,ind){
        //create new job rows
        if (id=="save"){
            saveUserScript();
        }
        if (id == "start"){
            startJobImmediate();
        }
    })
    
    var worfklowmenu = detailsLayout.cells("a").attachMenu({
        icons_path: "/webinterface/dependencies/dhtmlx/imgs/",
        items:[
            {id:"save", text:'<i class="fas fa-save"></i>Save'},
        ]
    });
    worfklowmenu.attachEvent("onClick", function(id,ind){
        //save selected workflow (set corresponding grid column value)
        if (id=="save"){
            var _wf_id = m_workflowForm.getItemValue("wf_id");
            var _proc = m_workflowForm.getItemValue("start_proc");
            var workflowconfig = {"wf_id":_wf_id,"start_proc":_proc,"inputfile":"","variables":[]};
            var cellindex = m_mainGrid.getColIndexById('workflow');
            m_mainGrid.cells(m_mainGrid.getSelectedRowId(),cellindex).setValue(JSON.stringify(workflowconfig));
            saveJobGrid();
        }
    })
    //EVENTS
    m_mainGrid.attachEvent("onRowSelect", function(id,ind){
        detailsLayout.cells("a").setText("Target Workflow");
        //show workflow selection
        detailsLayout.cells("a").attachHTMLString('<div id="wfform" style="width:100%;height:130px;overflow:visible"></div>');
        m_workflowForm  = new dhtmlXForm("wfform");
        m_workflowForm.addItem(null, {type : "fieldset", name : "data", label : "Workflow", inputWidth : 220, position : "label-top", width: 350, height: 200, offsetTop : 20, offsetLeft : 10,list:[]});
        m_workflowForm.addItem("data", {type: "combo", label: "Workflow Name", name: "wf_id", width:200, options:[]},1);
        m_workflowForm.addItem("data", {type: "combo", label: "Start Proc", name: "start_proc", width:200   , options:[]},2);
        //loads workflows from server and adds options to the combo
        loadWorkflows(m_workflowForm.getCombo("wf_id"),m_workflowForm.getCombo("start_proc"));
        m_workflowForm.getCombo("wf_id").attachEvent("onChange", function(wf_id){            
            //workflow was selected, show start_procs
            m_workflowForm.getCombo("start_proc").clearAll();
            var startProcs = m_allWorfklows[wf_id]['variable']['start_proc'];
            for ( i in startProcs){
                m_workflowForm.getCombo("start_proc").addOption(  [{value:startProcs[i],text:startProcs[i],selected:true}] );
            }
        });
        
        //show script editor
        var cellindex = m_mainGrid.getColIndexById('script');
        var value = m_mainGrid.cells(m_mainGrid.getSelectedRowId(),cellindex).getValue();
        detailsLayout.cells("b").attachHTMLString("<div style='height:100%' id='codemirror'></div>");
            var base = document.getElementById("codemirror");
              m_codemirror = CodeMirror(base, {
                  lineNumbers: true,
                  value: value, //"//when you are done and this array contains filepaths, one job per contained path will be started.\nvar filesToProcess = [];",
                  mode:  "javascript"
            });
	});
}

function loadWorkflows(wf_combo,procCombo){
//adds options to workflow select combo
    _combo = wf_combo;
    //get currently selected workflow
    $.ajax({
        url:  "/getworkflowlist",
        type: "GET",
        crossDomain: true,
        dataType: "json",
        context: this,
        success: function (response) {
            if (response['workflows/details'].length == 0){
                alert("Did not get any workflows from FFASTRANS API");
            }else{            
                //get currently selected workflow:
                var cellindex = m_mainGrid.getColIndexById('workflow');
                var currentWf = m_mainGrid.cells(m_mainGrid.getSelectedRowId(),cellindex).getValue();
                if (currentWf){
                    currentWf = JSON.parse(currentWf);
                    procCombo.addOption(  [{value:currentWf["start_proc"],text:currentWf["start_proc"],selected:true}] );
                }
                //add options to dropdown
                m_workflowArray = response['workflows/details'];
                for (i in m_workflowArray){
                    //create a combo option for each workflow
                    var _selected = false;
                    if (currentWf['wf_id'] == m_workflowArray[i]['wf_id']){
                        _selected = true;
                    }
                    m_allWorfklows[m_workflowArray[i]['wf_id']] = m_workflowArray[i];//store all workflows for later proc selection
                    _combo.addOption(  [{selected:_selected,value:m_workflowArray[i]['wf_id'],text:m_workflowArray[i]["general"]["wf_name"]}] );  
                };
            }
        },
        error: function (xhr, status) {
            m_mainLayout.cells("b").progressOff();
            dhtmlx.message("ERROR getting workflows, possibly FFASTRANS API is offline. Or you havee an invalid expression in filter regex");
        }
    });
}



function startJobImmediate(){
    
    saveUserScript(function(){
        var cellindex = m_mainGrid.getColIndexById('id');
        var _id = m_mainGrid.cells(m_mainGrid.getSelectedRowId(),cellindex).getValue();
        $.ajax({
            url:  ("/immediateexecute"),
            type: "POST",
            dataType: "json",
            context: this,
            data: {jobid : _id,socketid: m_socketId},
            success: function () {
                dhtmlx.message("Job was started.");
            },
            error: function (xhr, status) {
                dhtmlx.message("Fatal error, could not start job. Message: "+ xhr.responseText );
                
            }
        });  
    })
}

function saveUserScript(callback){
    //saves code to selected job in grid
    var cellindex = m_mainGrid.getColIndexById('script');
    m_mainGrid.cells(m_mainGrid.getSelectedRowId(),cellindex).setValue(m_codemirror.getValue());
    saveJobGrid(callback)
}

function loadJobs(dhxGrid){
   $.ajax({
        url:  ("/scheduledjobs") ,
        type: "GET",
        success: function (response) {
            response = JSON.parse(response) 
            for (i in response){
                jsonObj = {};
                jsonObj = {};
                jsonObj.pos = dhxGrid.getRowsNum();         
                jsonObj.id = response[i]['scheduled_jobs']['id'];
                jsonObj.data = [];
                jsonObj.data.push(response[i]['scheduled_jobs']);
                dhxGrid.parse(jsonObj,"js");
            }
        },
        error: function (xhr, status) {
            dhtmlx.message("Fatal error, could not load serverconfig. " );
            document.body.innerHTML="Fatal error, could not load serverconfig. "+ xhr.responseText;
        }
    });
    
}

function saveJobGrid(callback){
    
    m_mainGrid.forEachRow(function(rId){   
        $.ajax({
            url:  ("/scheduledjobs"),
            type: "POST",
            dataType: "json",
            context: this,
            data: {job :JSON.stringify(m_mainGrid.getRowData(rId))},
            success: function () {
                dhtmlx.message("Saved");
                if (callback){
                    callback();
                }
            },
            error: function (xhr, status) {
                dhtmlx.message("Fatal error, could not save scheduled jobs, check server logs. "+ xhr.responseText );
                
            }
        });        
    });

}

function deleteJob(id){
    dhtmlx.message({
        type:"confirm",
        text: "Delete the selected Job<br/><br/>" +unescape(id),
        callback: function(ok) {
            if(ok){
                $.ajax({
                    url:  ("/deletescheduledjob?id=" + id),
                    type: "DELETE",
                    context: this,
                    dataType: "json",
                    data: {jobid : id},
                    success: function () {
                        dhtmlx.message("Saved");
                        m_mainGrid.deleteSelectedRows();
                    },
                    error: function (xhr, status) {
                        dhtmlx.message("Fatal error, could not delete scheduled jobs, check server logs. "+ xhr.responseText );
                        
                    }
                });    
            }//if ok
        }
    });
}


</script>

</head>
<body onload="loadserverconfig()">

<div id="documentation" style="height:100%;width:100%;margin-left:20px;white-space: pre-wrap;overflow:scroll">
<p>
<b>General:</b>
Job Scheduling is for advanced users only. 

<b>Overwiew:</b>
In first place, Scheduled Jobs (Left pane) are NOT ffastrans jobs. Instead they run internally on the webserver.
A scheduled job is executed at a certain interval (or multiple intervals). How it works is:
1) Execute the "Custom script"
2) if the script sent an array of files using process.send(array)
3) start one ffastrans job (using the selected workflow) for each file in the sent Array

<b>Scripting:</b>
The scripting language is node.js. It is best if you develop your script outside of this editor and when the script works as intended, you paste it into this edtior.
To use custom modules/dependencies, it is best if you just specify the full path like this:
var dircompare = require('C:\\ffastrans_webui\\node_modules\\dir-compare');

As mentioned, all you have to do in order to start a job is to write this line for example:
process.send(["EXAMPLE"]);
</p>
</body>